package org.aion.unity;

import avm.Address;
import avm.Blockchain;
import avm.Result;
import org.aion.avm.tooling.abi.Callable;
import org.aion.avm.tooling.abi.Initializable;
import org.aion.avm.userlib.AionMap;
import org.aion.avm.userlib.abi.ABIDecoder;
import org.aion.avm.userlib.abi.ABIStreamingEncoder;

import java.math.BigInteger;
import java.util.Map;

/**
 * A stake delegation registry manages a list of registered pools, is the endpoint
 * for delegators/pool owners to interact with different pools.
 * <p>
 * Workflow for pool operator:
 * - Register a staker;
 * - Register the staker as a pool;
 * - Add the pool registry as a listener to the staker;
 * - Set the coinbase address to the address of the pool coinbase contract.
 */
public class PoolRegistry {

    // TODO: replace object graph-based collections with key-value storage
    // TODO: replace long with BigInteger
    // TODO: add meta data and commission rate setters/getters
    // TODO: add events

    public static final BigInteger MIN_SELF_STAKE = BigInteger.valueOf(1000L);

    @Initializable
    private static Address stakerRegistry;

    private static byte[] poolCoinbaseContract;
    private static byte[] poolCustodianContract;

    private static Map<Address, PoolState> pools = new AionMap<>();

    static {
        poolCoinbaseContract = hexStringToByteArray("00001a4e504b03041400080808003150024f000000000000000000000000140004004d4554412d494e462f4d414e49464553542e4d46feca0000f34dcccb4c4b2d2ed10d4b2d2acecccfb35230d433e0e5f24dccccd375ce492c2eb652c82f4ad74b044ae995e6659654ea05e4e7e738e767e6252516a7a6f272f1720100504b0708fbf738714400000043000000504b03041400080808003150024f000000000000000000000000220000006f72672f61696f6e2f756e6974792f506f6f6c436f696e62617365652e636c6173737d545b73d35610fe4eec44b6500209a10990e2505a2a3b05f5420a2531102750629498c6345768e7583e28076429d52533f91f7de181bef615ca8cf1b40c8fed4cff533bdda378929861fab267cf6a77bfdd6ff7e8ef7f7f7f0be06bfcc0301184aec565e05b892fe33deb7e1078f381f41b3c1242036338f184ef72cbe3be6bd51a4f84136bc8308cf4385e563e0cc60e1957842ba338dc6318b4f96ecb9a6b36431145330c03b392306e3064cce2aa811cf23ab2d019b2f1b68c18ced9ff570c25c8c521f7a3c7226418367b92578bab0c43ca52f102e7a9b3cda5afe10443de15f13cf73c1573dc2cf6041918c1491dc3183530002d8f3e7cc070ec888b86712a5bfc94708fea3b65daef723153dc34700667759cc604831692af0c05b5646eaa1ecfa1a000261946d3d0168fb7ad8a7417fd58b822d4f01105ed722f11b5c70ca7cd6ad17e9f1f95fa313ed1710117897a6a6945b4a843e9bbb77d11ba7b29a55503268a0aae44f80e35cd70a597a6f727dfaa54f789591151e2c504f6192ea93c9719f443bb86cf894f19d513c7a164292675ff25bed2f105aed0b7503872470a3f26d2782b4894c2aa7409d304b4204761689eb38ed75d890b07a3571e4924424f362cde90d65c657141384153b1354b6c51f70b3ce68ae2e256c5c00ddc54b5de62e837b72afb8b55d151c63ced6e338dacf9a2cb8081db6ae465dca17845e181cf9288b783e6326fd1f046cde29149d7e390882656165155a1f77218ea7916fb0e1a9675d4d4160c1ea0da81ef1af84e4da58c15034338aed3963d4829d915616c6055bd8261ac513df314445b6a4b5f2c27ad86081ff0864796113ba069aef250aa7bd738588fb9f37489ef74ef7a3d484247dc919ec079c2c8d20b27ab5a6cd2b2a4d37b23b941378b4e46677fe9358ebd24a50f9b240752e310b6481afb0e740ed299579577839f9355252f7770ea378cb5f16107e74b7f42cbfe8a6c86f442fee75f0e6fa542079f66dee43a98eac05abed4c634591568060f49e6901dbdc50c1a9f2ae10c15018c13ec599213b88802a6318959ea4995354951044dff2ed595d2aee21a15364d79bec175fa9ac3cc419f85d41b38f907ca1b1dccbdc6c2461bdfbec2d8dacbf4431e7771b3ebbc4ed07d745e3f74be576ac3b6a7fe82460dbc981a596ae3fe338c9554921f49d41fadaf75f0bdfad8c13a7b9152fe3065afef1f8c6b286ba84d90ed51ca71ff7f504b07084c6340e37403000079050000504b03041400080808003150024f0000000000000000000000002b0000006f72672f61696f6e2f61766d2f757365726c69622f6162692f414249457863657074696f6e2e636c6173738d504d4bc340107d53d344626b3fb4157af3207e41f7e6a552d0aa50091eacf6bea94b5c4936926c8a7fcb93e0c11fe08f12a7a960c18b7b989d79f3de63663ebfde3f009c6087b0976691903a3542ce1351e42a8b752864a8c5d9f9f8f265a69e2d373d10a1f724e752c4d244e2b63056276aa5bf4668ad2afa0b32a1c9865ac65395e50cde8f2f08745dc5f2b1a77baa8db64342e720f8b59fd84c9b687038adc1c7860f073582631f754ed80ffe35f180e0252acf65a408edbfde84fa2835b995c64e655c30c919a50ffc35026dd44d91842abb93615caad319af207911ae7f407f9216d94c5de9586117151e91f7410f2ef856687355c13a67b4d880e3162343c62afcbb47c76fa8bf969c6d8e7e897aa8b2a2c35977c9c2261ae59d5c34d12abdbaa5a6fa0d504b0708491bfa8128010000c1010000504b03041400080808003150024f000000000000000000000000290000006f72672f61696f6e2f61766d2f757365726c69622f6162692f4142494465636f6465722e636c617373ad9b097c54d5bdc7ff67669219269364b210024960020249580261dfb36b62586c804ae2c22499240393199c4cd8b48a2d280ab880280828c54a000511855045acdd9ee2ab5b5b6b5fb5cf3e6bd5576bd1aad59a36fd9dbbcdb93313bc4ef948e6ce3df79cf3ff9deff99fffff9c9b78ee5f4f9d25a2a9ac82d18840b0add8ed0df88bddab3b8abb3a3d419fb7a9d8dde42d2e2bafa9f434075a3c412b3146ce15eed5ee629fdbdf56bcb06985a739642533a3d470adf1bc02a301e5cb16575d3bbfacfe7246acc60c3b7d6a617d4d43152fb031b2b4b843a86c6a2c67645b15e8f486208151e26cafdf1b9acb28a1a0b1bc7029237341e15207a590d34e164a73501239069089321c944c56fe6d20fa0ab57b3b198dac3330945918488bf475be27d41e6859e0eef030ca2c28ac0b0faf3e14f4fadb503355aeb9d0ef918b1c944343ec309acbc8de21b44f8fd5da195966251706dbe609d5b7078221696cf56004e90cd7443ca8f1cbc53528f232b2a2a82ee06f93ca6a51e6c30fae0378b9c7df166ac7e00b6a78f591171a7bd5da66cf2a0ed84ac58c665702bdabd5ebf1b5b85a029e4e973f1072b5bb577b5c1e7fa0abadddd5b42e84529fa735e40a055c418fbbc5e5f6bbdcc1a07bdd781b4d6434b0207abcf2344db2d3049aeca0e13482739aca686e1cd6f87c6af6a6631ea43a8b3cc12a9fa7c3c31925494f5506c9da3c95a3a2440b6e95dedcee695eb9a0cbe7abea58155ac77538682ef72413cd6334331e0c52214495312a5ce0591b727964452eafdfd512eecf2bf7a655afd0bc8e6b0c047c1eb75f92d9c0684e7c3ae44ed0f7a58cc61a92a2b580bba46b6a2adadd417773c81394f440e8acb8f474729746dff319151951a3d65fc82825bccae475114685f5e069e3d2e2f122f8ac576e0f3b5860e30ce8129b2c71d0281acdbde5dba28bc90b323eeff1a12d7a6e30e83d4af5ab1c5448455cc83522ad6a5fc02d878bea7867ad9577010b4d06674daddf8235198e0092102bb5421ce8957b439d8b038a381e9daa1dd44e5e3bb5d10a31a45606ba9a7cf262ad8c3328a126ef0382b09ac6181980d660952e3ecb5aac044f7372e8f21854859682dac24a0785a8cb4e9db45a5c3d3cde94f150c46b15f26436488a3af3bd7e393855078272b674d07a39f45ccfa8d868e8d082e0771c348ec6f3e637e913cbbace90a7c34a37232948759b03aba0a5480cd0b2fd5935318a6a78d4fe1e6db4d3776913ba685287632507c27c64c812460a177634e94a4d8d0d56da0a00d1a14568870033d9c8e89bd5b61a82bbe05ecd113d9a1a2bacb48351863e8408f6b0ee27188e479aadfb90df3b859e4c8df556ba5f24a24426c112a2eaa46f126134630f60538032cd548d95be2ffa180f38829d5a83fec3fd58b3f13026d717eec7d4586ba543223769bd0a56aa0d7293228266e651706b157a3235565be931ecaf2256bd60086b7fa2f195ab597a027b8016b12f5363a5954e190c039dd29e05dd9c8e37f2683d3cc5685ebc5b1cad93337cef946aa77c3a8b752517ab9b9b24f996471aec1413e53b314996b5b4043d9d78968a5d2cdffd2905b38ca63cb75c1f3a7e1677a60df7f15f7c77165661a517ec748e8fcbea56852647c874284f943186bda5a45208b009f0161e6173fb89b0523507bd2a87d9d71895187185924a7da4fd9583d6d23adec3eb8c5c15812e54e635654d910d6cf406b6e4c811a32f78f8d036e018ac1983b0d29b62a0c43075a1541a2922ec14a303905b6b6378db41b7d1ed7c0cff87035e3f6310dbd8e88f923044f03f311a2c088b8ce1923404f16906a545c7f1ff77d01d742717f7218e2db1c545b4b2d147885fbc505101a908fc1f8b01b9a4520cfd92cc7a6311991bd487ffcf1cb493eee512ffce283fb644a1858dbe942421477ca59f567d969044d5189fd6c844d1e7a0bdb40fb218eb775a756d6ccc2c09abb1b204fdb212728aa4aad6f86a11f30a1be0a087e8075c5252bfab25dcc0c692253db55696aa9f3b31fd4882aa8dcf9d2e05b10c071da147b8a281fdce9dd0c2c6064992aaad6c30a32c41922e53499a2a0dee5d60419fad589e831ea7135cd430c95aa595e58b13229fa1155b03612bd6fb044369524e0f9ae1918c86c56020d6b2b1d15a92511464c4b06f6545e29429c15b69e0e492f531ddd85e4809fc9adef10efa09fd94839a1073f6225ad85849387b285a52f44aac6c0ab6328b835e4f0bcf574a47adc1400738f8bb7c3e5720e8f2f017048242289916e7c9dcef0a48d9085dcc6054f19f74a15101cee48a80bf33e4f68796ba7d5dfc4c52816120e5d779fd9e055d1d4d9ee062b7745849af0b34bb7d4bdd412fbf570a93eb436ea44cf72ae5de5e1fe80a367baabd3e0ff61c26b210e1670825127fd537077726b2e17e8070cfc3611239a4efc928271a498c6f5b50632eee16a2dc846b6a510fa5178d39499945e69394f5386fc0e6e1335d329382cf5474ecc4b734568a922cb9190da26c22e91b3783b44a832141ee7c8dd2791e2b7a92321f2687995fcfee271babeb265bd129caab1b731c15ccac0c9f7632a7597ac962a57cc1b48bd230da2c1a4139345232ed223365e067280d833974af88c88131b9ccc45f6529223ad00b17318edbc64fd624a76ded8ed939eaad65f9a434eabb71c38ed945cb709bb01cc3cf793462fc85187711648cc17f6385f18f534ca7c0ec25125a137ffda098dea7985e229a8eb6ac2b4c885598a814ca12ad1112b907104dc0fc4ec4b84b681a4da21a9a4cf5344590ba44919a4c975101f710941662509254e6a004e22f799f14a56e2a1d16a175d3cd4edbba706942ccd2c498a5d698a5b698a5ced85d38b53e4a25104e1b2731eca846a2083e443403d33113d3310b9fb36911cda1569a4b37d03cda41a5d44d657482ca05324f6a9378904faf4406e776651277810b273343f25d2ea325e100253f4d1396a597f4d09467b172a6cd093fcccd69571fcfe08f731fd51cdc4aa6ec5e1aca8459ab86d54b61bd165e7c39acd661f616695ecec7a22eb019180d9fb53ccac5c8d015becfc6d864953b307f7c2d5c0e35a53194964b4a39470eaec1c2c14db23ca83cad8cf534ac1b5e9c9b2788be12250d58198d9072351cef1a485b2e8976c82214d18caa304059e0038ac0fa7e045e164b42822ab036d6d3dd64b57493c52c02b6e4e665958a80dba17505b4ae84d60e68f543eb2a416bbda6f572c097b56e56b496eab526aa5a17c45293a86a5da43ac5f6fe09ae45c97aa8ba1eaabe03553742d5064155a9a6ea0a2d90ddaaa89af74d5459a354f52f6a334a6e87a82d10b50da2ee80a8bb0451f33451dfd2425c3fa26caaa8c5b144d954514b155157f62f6a174aee87a83d10b50fa21e80a8fd31452d5383198e51b2a832bd28e7005555632c554e6d06af56645d7b5494953754907508254790851ec17a3c8a987b0c6bf1b820ab4c93b59cdc8aac2d8aac8a7e5835c754a5cda04785759a561ed3f112859d46c953e0f534783d83847016c1e24782b00a4d980feb4116b6551156d91faf404c65da345ea7f23a4d6b1eeb17d9f3283907642f02d92f80ec25207b455056a929c3515e51d6aba4a5b592b21eba81d5851354c97e7209f9c999b69f9ce11cde8de1442a4e5315df2829b6f4d08639b9676c5a9f63ccb9a7e916a9492e6f216c4e32c9dc4b531286f6f1ad9795ffdb0ca97c7425d2f6ea0d8ceeb7d87efd0e29e84d24d8b7680afd2fc2fadbb498de41b47c1751f24f60fe1eada60fb400dfa005731e13e4f1db11a36e55f652b76141ca09ba9a0737be488d90488f20b1388a447a4c12963af3dcbcdc0374c998bcfe82ede28d66d6ddf79640a694121532497cef0632db70d2a53e4c73f856baf471afd08accd2e54b4a94284ec5c684e8638cf11350fc14143e03c5cf41f10b50fc12147b41eb5fa0d847d80bd3065c6fc149b9544afb162cb351d2b686331dab31ddac31bd11cb6fabc4f40eba53d8f470a65d46986644302d8b629aa132bd5b629a20334d5098a681294f0a4b2480e7058083c91201f01e0ef04b4a0f93617804bd36964276964a05cc89cd5d3ad5b20c5accb2a88165d3356c30c80ca10e5c3b599e40264323335823d3a5915949dbb17de06476d2bd0a9924854cc80899cc0832a55164325532bb44320314324e99cc5209ccc71704b34706932680190930a300a600600a01a60860c602cc3880990030250033096026930fd7208e886130e91a986c0d4c4803b3827623f570307b917ae20033f06bc10c54c13c2881b1ca60ec3a30572e3400e64034987900530a30e5005301309500530d3097024c2dc0d401cc7c80590030f301e68a6f00663f7d5f02f310fd209eb594f5b56b294b05735002e3b4c964927464ae5d7401320e85cce16832cb40a60164ae0299ab41e61a90590e326e9069a146d64ad7b2366a65ed584b6d584b2b35326e8d4ca340465c4bddd81a703247b03590c9a42864d618213328824c451499412a99a3a2cb242a60326497c116e10a89cd4717f49ae3329b4c814d27d884c06635d8ac019bb560b31e6cae079b1be1351be03537c36bbe4b015cbbd826c16b066a5e93a3b159a3b1e9c026e93189cde33880c96c52153686f27bf6d7e6f76c95cd933aafb1eae0f05dcab72e0047759c9e6838db00e70ec0b90b70ee069ced80730fe0ec049c5d709cfbe1387be0387b71c4d843abd98382e30cd41c272766ca3f49a7243839eaeb13f66d05ce712370f223e0dc1005275f85f34375371771047b3ad669567df88c74963d635ba01a1d17b1577a9af2978deba167eb74501324a8837a2917d9ff1265e794afec9caa290ddfb0ab608701f511407d14508f02ea63807a1c504f50137b02f1e9245dc77ae826769a6e6367b06d780699e02c3dcc9ea563ec390df275380eff884602ed36d8780e33c9f78ec735c807e9c7d2eb21c65f572a902f517698f7a9907588878b8887efa7f43062fe0aab390af27015f2cff5909d2e15e4f3fc81d375c6365fed7bacd9e952513a5d32cb73cbc6f6d08b224bacd92943b37b69b495ce49f466520af4bf007a2f82de4b348abd4c13d82ba0f71ae8fd12f45ea766f61bc4b0df21babf4937b3b7682bfb3ded646f6bc44a30f6ffc66e9c5110e7cc97408cbbe57d0ab19db8939f327a995e5188ad52dcf29042ec97116e394164365170d304718f9e28bb694b1441b4c8ee7fe3fe6b6103f10c6d16d2c129fa4dbd9c0eba29658154f9b7bc321032da8873e41e9c1e659463c9da4b55098503c28bfd2dbed8d3fa3060b3724fcc4a13fe019fe4accbc98991bf0fd61f80f59f51fa214d677fa12af657c4c1f3b48e7d0aeffc9c36b22f680bf6b4db71ddc5fe092ffd8af6b25e3ac8fa24e693c1ee162d87ec854ffe0f4e0c66ba09076a35281cd2fcf5019c03de94e8ff1e67898b403f3d3efada61e10f3afadb74f4df89a4ffae71faef45d07f2f067d145b4c36b299ec643725d1749383aa4c291430a5d23a5306dd641a481b4d83688b299bb6e3bacb944b7b4c4368af29870e9a86c6457f0b4e6c9cfefbf4c1c5a09f111f7ded58f1671dfd7b74f4ff1249ffafc6e97f1241ff9358f44781fe68d02f04fd22d01f03fae3407f3ce89780fe64d09f0afad3407f2ae8cf02fd19a03f13f4e7c445ff3c4e839cfedf701abc08f433e3a3af1d5d3ed7d1dfa3a3ff4524fd7f18a7df1b41bf3716fd2ad0af06fdcb40bf06f46b41bf0ef4e783fe15a05f0ffa4b407f29e82f01fd06d0bf12f49781fe5571d1df4d5f49f4ff8933b74c3fa8d03f120ffd8111f45b8dd1c7f9288503cd60a4c37f40c4cf4c1afed405726d8bc67f1346b2378abf5de3cf12f5fc71aff04f12f8b780bf07fcdbc0bf1dfcbde0bf12fc7db4deb48a369882b4c914a2ada62eda81eb6ed33ab05f43fb4c6be990e97a8dffad1aff7d48e732ff0d2851f91fd1f8efa7fd8cbf9363ccca6c17837f567cfcb334fe761dffc33afe8e28fe29c6f93b23f83b63f1ff1ef86f04ff5bc0ff56f0df0cfeb783ff16f0bf13fcef06ff1de07f0ff8ef00ff5de07f2ff8df07fef7c7c5bf1b6713ce3f8da55f0cfe83e2e33f48e39fa9e37f5cc73f2b8a7fb671fe4322f80f89c5ff00f83f04fe0f83ff41f0ef06ffc3e07f04fc8f81ff71f03f01fe4f80ff09f0ef01ff93e07f0afc7f1817ff636cb0c43f87e52afcaf53f81f8e877f76047f8f31fed91affa13afe3d3afeaefec3ffd7e21f1e817f78acf0ff1cf0ff18f87f0afc3f03fe9f03fff3c0ff02f0ff02f85f06fe5781ff35e07f15f85f07fe5f01ffafa9dbf4464cfc760d7f38fc1fd6f03f482759be847f040e4817c1fdf3e373ff7c0dff281dfe7c5df6cd8b72ff02e3fcc744f01f13cbfddf06ff3f80ff3be0ff47f07f17fcdf03fff7c1ff43f0ff08fccf83ffc7e07f1efc3f03ffbf81ffa770ffbfc7e3feac901549fcc7b2711783fff0f8f80fd7f817ebf89fd3b9ffc428fe938cf39f1ac17f6a2cfe7d64c119dd663691dd6ca6e9660b559913298016ebcd49b4c19c4c9bcca9b4d5eca41db8ee3667d25e733aed3367d02173565cfc27b329d2df01cc857df95751cb505bfa6b93c83f6651084de7637e9c84df7ea5c94b3885bf5f300fa134730ee59af384df78a97fb862e2ff9781626689626688ee058d6263a6de066a0e164cb828c59c4f83cd230413433413af5ec844a26662f6054d8c8289d1305118c30463e592a1847f03504b0708d6826f4acc120000a9380000504b010214001400080808003150024ffbf7387144000000430000001400040000000000000000000000000000004d4554412d494e462f4d414e49464553542e4d46feca0000504b010214001400080808003150024f4c6340e3740300007905000022000000000000000000000000008a0000006f72672f61696f6e2f756e6974792f506f6f6c436f696e62617365652e636c617373504b010214001400080808003150024f491bfa8128010000c10100002b000000000000000000000000004e0400006f72672f61696f6e2f61766d2f757365726c69622f6162692f414249457863657074696f6e2e636c617373504b010214001400080808003150024fd6826f4acc120000a93800002900000000000000000000000000cf0500006f72672f61696f6e2f61766d2f757365726c69622f6162692f4142494465636f6465722e636c617373504b0506000000000400040046010000f2180000000000000021220000000000000000000000000000000000000000000000000000000000000000");
        poolCustodianContract = hexStringToByteArray("00004e31504b03041400080808000d5d0e4f000000000000000000000000140004004d4554412d494e462f4d414e49464553542e4d46feca0000f34dcccb4c4b2d2ed10d4b2d2acecccfb35230d433e0e5f24dccccd375ce492c2eb652c82f4ad74b044ae995e6659654ea05e4e7e738971697e4a76426e6f172f1720100504b0708bc26827d4400000043000000504b03041400080808000d5d0e4f000000000000000000000000220000006f72672f61696f6e2f756e6974792f506f6f6c437573746f6469616e2e636c61737395565b571bd719ddc7e8ced8d898d8c12136343191c044c171dc041cc708dba94180030eb6c1a93b48073146d290d1889af492de9b5befe9254d9bf6ad4f59cb75d7c25a4d561e93b5f27ffad8aeeeefcc44488eeb2e3f3073e69cefb6f7b7bf233effcf3f3f0170127f55e873bd52d676dc6ab65e75fcadec45d72d4fd66bbe5b74ec6a1c4a61ef0d7bd3ce96ed6a293bb7724317fc383a14badb0c9f141b056b839bf3bae4d47c6f4b6177dedeac64278a454fd76ae30a7b6abebdaebd1d83d82987494f2b74a4338b169248a51041a742c45f736a0a87f3f7ab8e11239baeaf15f6a5db324d651615f67bfad5bae3e98b2d2559d8272976a15b211e9e33487a49b2f7e021393aa070ac9955a2d66bda2b3b2b597bc5c94ee42e2cf89eb62b4eb574ae5a708bda8be3e1147ad19940974297369b73554d33da28e4d2f91dfe82cdf14cfe41128c5be8c3a392e3309bd14c10825578be1dfc0307efc78004ff0a29f1dddc96af6b4249663967e1711c95a3410b09c4932427add063e0546c7f2d9b734a17aabe2e09094374dfb4cb753db7aad09b9ecae4ef65c774c73092c2309ea41ca4be5cd92dac17d66c87627b8ab22a697f5e57f8696ad45e69cba863cac2713c9dc2284e28a46aba50f7f4a45d2e2b9c68877fefb4cb39162466f3ba562ffb2ce324be2add7e96220c54c9855d71eb555f414d9181a2ed53d1bb96730a897a557476c9a522ef525a3bf55309bc40d9377b94774502a3c2c6033625874961fe2c0b593a373fa770e07ff1791e2f26c9e7d7141ebb5f8eb33a542bb1a576988823cf820de97eddab9e25680bb3d2f619306b34bd9c0b26f3a514a6314fdba26e0167e19274651a2f2b243d5d70361c2d0cc63c139d37422beb9c0fdfb3abb555ed2d08e742e8f05dedbb3fbb4be463d5732b6c8c4fe7bdab4ed52e3bafe94b6158512ea73f81ebb4708aa217ce73b2e0568b8e4f66d85b864812af8847ecbbd299b62c16565112bf350bb140f437143a5b4ce2a0ea62bc3cec3227e5a1d6f90eeec7f1cc92852adc142ad8604505a6b2e089e0464197a4535ba8170a6678296d1ad7b129847f93f4fab6c7ea9ac31d3533c502b49985bc5371c86ae254a11cde9c715a075dfb8e746d14df252dcd1e85712c7c4f404de3fb2c4786ab6933a3fd35b7386b5798a3279df9f25d65e147f8b1b8fea4ed9720388de38d14dec486852eec95717adbc20b3823ab9ffd1f3d366fcf5f88caa6cc7593c3af52f8257e6d6109cb12e45d0bd7f10d59fdce686a537bbe853fc81d3e8af788659231d8c3bc53d5b3f5ca8af62ed92b65ee74e75db2be687b8e7c879bbb29bac2fa8cbd117ea716dcba57d0e79db2c6007344f89bb80b29693b5729b9f3cc5bc90f139feff32bcbb7e23b3a7407d6df8dc39ff88c99cd7df8339f566080ddd8c37752a8099d3fe4ae24996860ffd0a78847fe86484703078f24dffd60e7eb23f45ebd8343dd8f6ce3c8d0361edbc613b3b79139d24076a481671a78eeb224eec0077c2610e93ca3ac33ca9431c874c0a33ceb67da01ae1ee7de510cf1398227485a1a67903165f6d38aa560cca094d5384eb1d05196fb3c4ef33429bd0c4bff174b8ff1bd7adfd2473efd328c8910c6916d9c1b09e08c4588e7362ef446023c63d18f307db537ba8d8b77b0b08dc50f9bf83a110bf0a54288c7c92f08a6034f11e228211e27a067f83c29773ae13ccbe29f33c0ce13d2224109dc1304c0f29b705743b8b2baccbd0e5af71be011faecc5155ca54752941850a0faf82dbe37efa260b865dddf46476fe41e7c5c0bf918e65f3f39e98d84a4444352a2212931434aec1ea4ec41a2d330425e3a435ec68cda26687196bc9cc323c493c18be4648a6d9cc624f2fc9ae16a16173187053eafe025ac61def073dab4f7265e09f9b989af73a5cc4a98da6556c254847e0153517a074cc5c8142735148bc71311d72099fa02b64dd8870997486702a0c75ac41c4cd16193fb327d97d8e565c6be86fdace8206b39caf852e70153c92056581378d2652a91b1e5ff6f61fea7bf18d2430d1476c2a78ceb0a0114da06b5086d4ef735a73c632c81dd0d38b7b1be8d57d94009a45a02ad3240896b515de0560d87a46768f8d84003fe5854347d539410bdd52c638fe1e606195b67ca728b3a7bb015b2df83d7d82d6556013e597d8b98652c3b437526f0ed66c983262a704854d3c0ebd4ccd56dfce01f580f5e19c3b3dc473f249781cfc7cc2691dfdff199a6347f9a1ffe0cf18e8f13b786e5127aeb3d1c1c9220d7f9587ce5cae506de090e27cc615feba159d2e2e70dfc8616d78cc540d3e26eb3df0666b631eb1e6a26f8bd2468e08fea96215d44df85e8bff1701cd371bcd937307890db7f319c46ff0b504b070815b48912ab060000cf0c0000504b03041400080808000d5d0e4f0000000000000000000000002b0000006f72672f61696f6e2f61766d2f757365726c69622f6162692f414249457863657074696f6e2e636c6173738d504d4bc340107d53d344626b3fb4157af3207e41f7e6a552d0aa50091eacf6bea94b5c4936926c8a7fcb93e0c11fe08f12a7a960c18b7b989d79f3de63663ebfde3f009c6087b0976691903a3542ce1351e42a8b752864a8c5d9f9f8f265a69e2d373d10a1f724e752c4d244e2b63056276aa5bf4668ad2afa0b32a1c9865ac65395e50cde8f2f08745dc5f2b1a77baa8db64342e720f8b59fd84c9b687038adc1c7860f073582631f754ed80ffe35f180e0252acf65a408edbfde84fa2835b995c64e655c30c919a50ffc35026dd44d91842abb93615caad319af207911ae7f407f9216d94c5de9586117151e91f7410f2ef856687355c13a67b4d880e3162343c62afcbb47c76fa8bf969c6d8e7e897aa8b2a2c35977c9c2261ae59d5c34d12abdbaa5a6fa0d504b0708491bfa8128010000c1010000504b03041400080808000d5d0e4f000000000000000000000000290000006f72672f61696f6e2f61766d2f757365726c69622f6162692f414249456e636f6465722e636c6173739d99797454d51dc7bf77e6cdbc490830d903594c58c32421122068150412a213b280935201854c92491808332199a8b810545c5a6d2bda0a54292256aab605ad2cb534ed3fddeca94b7bda737a4ecfe962176bb773fa5f5b35fddefb5ee6bd799398349cc3ccbbf7fdeefdfd7e9fdfef7797c91b1fbd3e0aa01edf1358181fecab0d47e3b1daf0edfb6b87872283fdd1aeda7057b476c3c6e0a65877bc2732a84308f8f7866f0fd7f687637db5ed5d7b23dd091d6e81b996d472292090b1717bc7a6ddad1b429b0544d04d3d6302deeba3b168629d80bb72d9b62c642033131a660968893dd12181c52dd330e33a81d911f5d81e8b6c3c988808782a372edbb991d3f48413d42df8e81d8c0c0df727045cf285df1a108ff747c2313966871a2376e8c813c8494a34ec090f86bb13914129d360c83408cc490a84f6c40713f265c87819b2cf1f8c25227dc6d8a07a6dd9da128ff5c9fe66f67b60fc2314d16c9fbca93f1e569337a9d1732ddcea8d8e4a4af7cac78e38756d8c26c84da374300b0154656219aa396793804fc230decf4d4edf181feeea57c41ad5fcb6701aaf74d4b1b7473d77c4a5c9e32a1a973567611556676225eaa9a2d10e4dc661c3e060f820c957ee34a2b1f863837967776420c1973a18d07235b6bc3f12eb4bec29df3f3c9428ef8d26caa3b1f2baf22e4e3de4c35a81fcca16cbdc5062301aebbbcec8a31b32713dd6a7b8133a389488ecd7414332c272f6eef800ad0bd8e73032f8bae0045d413971233665a2018499ef4c20cb59338da2fcbf57a61bf3a945a0303d9fac214656b97632ad7253d3ca9209993221bb7233bb2ca9a02915b4074346cd126936459aedca543259324da60c3dcd73e48a25d4680a35da13ca088340c144b1716498d1ada38bc9d91749c89c519945b92cf42092896ef40acc1a5272e6eb9cf479edf5b6a1a787954eb9ecca16996666dbd03dcbd6a3a39f1d89783253b310932af7232ef3cf102abf233c541eef2d1f8e45ee1c601e447acc9cf4e1804056d890322d9b9da2d04eaeaed1560f7ae54e551059b8169fc8840b77d0d8defe70221189d535aa454d11cc90724143f220ee92927793bba13fb98ef4a859a9dd4d691d23f64ca3da94e4949a77a8f96e4250cef7801ac6047d50609e6d983345e5c00635b00ded72e0a7d5c0061d8fdab3b1aed19eb37250480dda8a9be5a0cfab41211d47538d4c4d62392ca88675e09372d817d5b0a08e63a9baec292b0735a9413bb0530e7a5a0d6ad27132350eb65290639ad5984fe11639e6b41ad3ace30cd3d7362625efe5a84635ea36ec92a3ceaa518d3a5eb46b3232d31c5358b973c262c84227c2728eafb3142710d171ceeeb29959e6a4399cd491e059d88b7d72be6f724f487dabe302a73272a7bdd7d8397b6e36b7c4cc684f249688f646e53ea5f74486125be2329f1be2b1a1443896d816ee1fe61ea13570106bbd251a8bb40defef8a0c7684d5e691d312ef0ef76f0b0f4665dbec9c1d4a84bbf7b58607cc7666283e3cd81d698af647b082366adced04e6c30b9e23f03a5b2ef850c64f1e03d8f36df6d4f25bf0db13b884ac5794c8157e7a55e76c7c879f5986005b73f89d81b9f09b83dbe0a63c30c773c5d752e5d63aaab4f91d55e793b3e428130af95944c5f338d37c356381310ad99400df662217799c3303f97c67cc7dc89cbbd098db23e73e015d3b0bcd7dd450e2863c4c55c035c6795c42a716173fc498344035ddb2296cb62ce4e722dab2989a96d86c29a42d85ca96dca42df368ad614b37fba5d4555e658b57dae2f7dd958db14334c533df7cb01c2f8047b1d5703595ade0847528e5266e29bc8a0a8b95c2e2a4c212ca4ca8509fa6c2eb396c2d15aee3843770b2f50e85650e8557a1dc54f880a9708d4f29f42985459642bf7ffcd96b33444f37a48cb90604395d330dd94c452d54d28a6a26cb6ab4db0c5a43837465d0caa4411558601af43653501e6113fe8c2bbed66ab7dfdb51ad95f9afb93b0f0b471e39da51ed29f35f9d6c78cbfc95c9865ee62f4f367c65fea264c34f39bfd5a2a0cf6af9cac61f2d6f9663163f6f21dced4cd21d4c919d4c9f5b19d1db087917fddbcd379de8431883e8b27997a0778b55d9c49577b2e69660a9e9dd317a2dbd5b2b712fb88c9ab5556ebf8c72890d7a890d7a890d7a491af405440dece3a4fd54b39f951563eec6a97080897700d7d138695ab9a194a62d57e0af4d825fc564d5959157d339c3c87719029955075508965cc69a8d8c838f71a8b0c7a1c21e870a7b1c2aec71a8488943454a1c2a52e250911e873a2e1dc0dd34e71ec6e15e2e4187582d233c791fe665ea3e1e18efc71626f12e1c21820771071eb2397c900e5fa362913063914938b58c8f9b0ef388603afc334ac8d8dd22022f20cf5877fc758c8a3fbbe32c1a02a3d92363cf63f6b771fdf69c7597b0e1bb81514fa7d669c865532e306a2b528aaba780bbca1b18bd8c1b6d6b5626dc05d91fa046ae51967f47a9ff095af42403f805e6d153aca663a8c40986e44bf4f369faf90c6be924b6e154d2bf0c2ecc461865a666f309945f9a0c2d0f22867f6225432e17c10369fee5d0bf5b3fdebf9cc9fc73aff5ae2b098c3e87e2aad240c94a6b8d3ee21247dce2ecd81f6d8ed7c35b90fd112ad5ba3c466b351dadc6229d5cbaad2e63f9fe377149489f50fbcf4b84f432ddfa1a5b5f27a47384749e905ea5d3dfe4fcaf11d20542bac833c725f4f23bcead4fc25ac59116ac76c26b5639bf95336ce6934c950334a945015c9f04c8039909b0cc04389206309700f74e08708f8530774a844b25c2559644a9d6c9b6d150385d67c77e65c339179ac41930392d539cd6b11bf83ebdfd01adff2139fd889cdea0973f21a79f72b97d93e5f0163671916dc73b5cc07ec605ece72c8e77585abf9c80d5562edf06ab106fbce3ac46c86a0bbf5792d8382b9e43a76495371d5679d363b5dac16af58c58fd8edefe9ed6bf4b567f20ab3f91d59fc9ea2ff4ed7db2fa2b59fd8dacfe4e56ff20ab7f92d5dfc9ea5fff17ab9083150fdf26ab2693d5a93456f964f5998958e93656f953b2ba51b25a6eed2d8ad5726b7f29f5a8b6c5d22bdb3696dad9b16f4dce32a85836d147e043d2f888de8d610e57a402e1429970a35278b05278710d8f659b840fed2203db4526fac42c5eceb2f0b0988d2fb0efa4f04fc8b425c9b439c9f414f56d534cfb934c79cf30999ee6ee2599be9fc6b4804c7f311153bfcf06b5604aa84725d45a6b2b34a8d65adba181b5d6da120daeb5d6b65855aaab8e22abc3a73afc5687df18e3b3f5a841665385c777762c9e1e9e2a333c4faaf06ce39117a2181e51820c51caf094313ce50c4f05c3b310abc4225c2b16a3492cc116b1143b4425a26219ee1201de41abf08ca8e62daa06a36239de16b5f80d65de13751384eb66ee5c46b83ab88f8d87eb7d866bbb92bd980c17af9266b86e61b0e461e34c5ab80a19aecf4d55028553466b73a0e46a1eb4eab5aad27c2da512d8b417029bf63ac8d752cbe0c2e465d0aa3837cb4b8d584bceebc8f906725e4fce1bc9b9819c37b10c9a580637b20c6e6219045906cd088bcd888916dc2b5af19868c371f69f165b15db754c648b6d98e7667954d358145b9245d196a47c86946f55453190a4cc6bb449f91ce7f24e581445d32a8aa2a98b2250b28227c535c45ca0a5d606db29a5c1764a65b09d52186ca7d405dba965c18ed4aa28d0fedfa2d8c1d51ee25606eb36066b1783b59bc10a33585d0c560f8b22c2a2e86551f4b128f6b028a2e8127b3120f6e1b0e8c7e3623f9e15319c17717c4f0ce01d718085b18785919820785ddc33e4b153fb9812d9ed28914e86dc389ebec10291529bd38257c1e0d5072ea2afb5da7662abe0ab6a7bb0aacd6055f3445aed389166c055f001eac60fa4eae22346c8e530b9dc472ef793cb11148b07b1483c8465e261d48b47b05e7c1a41f1a8f23540bf2c5f8b39c71e75d8a6c5f42bcaef45b663e95ede570cbfde34fdda90e6d702fa554dbf065afde5d5a3a7ccc41c9489e9af30e416486f34a737853c5f7fc8f58eeea8df0674ec979ec1e6db53f4ed187d3b4edf4ed0b7a7e9db3358204ea25a9cc20af12cfd3b8d1bc499097d5b8421d3b70df42da14e8cfea46fc3b8dd2c38b7b9ac6d91becdf3da7c5bc180a87b45bdbe3630fa1d14b5b9ebb57c4dd650490dbff3b5bacbb833249feb463bd71ed178927eb7a6c49f7d19f7b4a4fcfca1158ff184ecd17917e2ee7a98bbee556332b5f86c395d4fe321be41a7cfd1e9f374fa15e48a57e9f46b281517b0505c448db8c495e932837a9109ff3adac4155b12e798ee2d310fce1a4ae9f4bd2a8917a28a37b21115c62d043202f9e3902b09e43edecfa60524670a2047d281e44c0ee4212790879c407e48203f22901f13c81b04f21302f92981bc49206f11c8db04f20e81bc45203f27905fcc10c8830e200fe391e901c99d02c867d281e44e0ee4312790c79c407e4b20bf2390df13c8bb04f20702f91381fc9940de2390bf10c8fb04f21e81fc8d40fe3143208f3a807c169f9b1e90bc29803c9e0e246f72204f38813ce104f26f02f90f81fc97403e20900f09640ca52cfd852e811a970bd7b8dc58cfe72697076d9c6266408e3a803cc97d615a40f2a700f2543a90fcc9811c770239ee00e2ca81c7958b0c571ee6b8f291eb2a40b1ab8840e611c87c022926901202994f206504523e4320c71c404ee04bd3035238059067d281144e0ee4cb4e205f7602a922906a02a92190e504524b202b08a48e405612c82a02594d202b09640d815c3b4320271d404ee1d9e901299802c873e9400a2607f2bc13c8f34e208d04b289409a08e44602b989409a09643381b410482b81b411480b816c21909b6708e48c03c857f0c2f480144d01e4abe9408a2607f29213c84b4e20b711c82e02d94d209d041226906e02e921900881f412481f814408244a20fb6608e445079097f1b5e901a99802c837d281544c0ee4bc13c8792790db09e40e02b993400e12c85d04720f81dc4b2087086484400e13c82102b99f408ecc10c839079057f0eaf4802c9802c86be940164c0ee4a213c8452790cf13c8e3047294409e20902709e48b04f214811c2390e3047282408e11c8d304727286402ea400c9947ff5364fe1ef9957c350f1155f5b8d9b186ab4928e1a8fedba57e31dbfeee9f59abbde93ef91501606f23d756e45c65327cfe1e65367bd76c44336bfaeb198cc826bfcbabcc43a8bbb4e43733d47efcf60b6eb79cc777d058b5c2f60a9eb2c56b8be8a0dae17b199cf5b5d2f27bd0ef026217d95210c290fa19e2ea93f75caa7cbf2dc4f16edca5737e5abf12d4547e0bb907f58f0fc0f504b0708fbc81a0b080f00008e250000504b03041400080808000d5d0e4f000000000000000000000000320000006f72672f61696f6e2f61766d2f757365726c69622f6162692f41424953747265616d696e67456e636f6465722e636c617373a59a09785bc5b5c7cf4896ae17d971bc3b0e89ec388e2c9b3876626785206f898c6c93384bb310232b4a22624bae2d672969e96b69c39640e1a5af2d614d09af29a504889307ad29b474a1a5ac5d780fda4268e9465bca4e4bf2fe33ba91eea66bcb7c1f1fd2bdd69cf33fffdf9d3333179e3cf3f0181135b11646b591a1ed75fe50245ce7df355037321c1cea0ff5d5f9fb42759e666f4f7428e81f0885b7b7850391adc1218918a3dccbfdbbfc75fdfef0f6baeebecb8381a844564625063f9fcb7fc9c8de37b26d5b708851b9cf309907379ac54f96322a68deb0a6adb7adaba5bbd5dbb5a2d7d7d6b562cd4a46cc6b85620ba3e2e6ee6e5f9ba74bff938296959ed5dadb7c14d415f6acec5ebd463f26dfdba5bbcb87d810ced78d5b067fcb40b8765fb7c7205c516bf7da669f81fc92aeb53e5faf67f56acf86deeeaeb6de566f675b578fb7bb4bfda735ebbb957fb22f0b8543d10b19595dd5eb1c544c25999446a55662847f668e63a644d319a5fbfbfb23017f34c8a8d2e5ad1e17808366d0cc4c3a8f9c0eb293944116aa609416dd111a6634d77878928705306dae4dcdd5eb307ef7907f90d16c7e39010973c8c5255423807f68c8bf979165533323291a69de1b0d42489aab9adfc8da1e8c5e12190e45315898e475501dcde363eb513afeeae1c31d349fe6f29b0b540f6fcfdee1687040c234a00c91261019442ab7cba77dc0977a0d6e79399245b4389316d212280df407fd78c667b92652e132ba800b025a7b7f30bc3dba037283dc36d8c7285b7c0d768783bc5e46f5ae64b625b75e1a1c89c64657261dad92d44a6d5c523bdcddea8f62da32389c9b501289a0c03017b3316531995cccb900954903a8f4f8a893ebc134601b19e5c585b4ecf00ff90351de4fea5d2d93f28587e03a928d56e9e8a1355cc75ae840bbcc89ebe8d911198a720d3d296b488706797865d2e12a111b691317b119227a9454bce168707bcc8a64933bb90c3b64208083fcb129dfa77cf27c11fe24d6bb3a26e5706c7465d2d1aae2b6d1769e1e738075281d6eef8ff885c3ed9372581e5e9974b84ac40085b9880844600a4c898b688d8cf4f58b39d89ab28a0ca83837be32e978958c288d7019bb20a355f9d4f3a9ec89f5c286e45d34b994fcc08e6060a74ff41aefb0477efad25ca28b5d41fb32d1e83f8d1e0ac50eba32d67f3f8bd5163d3436a87b9b5a8568ed5e2c85da0e9150997a9fb0f685a2bcd96f94683fa3699ae4aaf8361e1ff98bf58d21a120f5f6c0023c7f8b4407194d57e7d7c6b7f1f85090af6e0989eca9370636ccb3f7487408fb027576656c1b8fadf25eee0389dca9770316e2b9bd121dd639af8e6ee3d1bdca8793cff644ead43b06ebe7a93b243aa27be214a16d3cb4ca6f31c31389536f136c1b4fdc2ed1319ddfcad8361e1b990b345d21913af5dec0b6f2d4ad121d6754aa4ead0a6ee3c1bdca8e84606297d0acdca8c46e2e4d5946ae36844427635b27b1d572d0fff0add3297a18bbad61f103790b96a74f0e8334cfacacb4d04829f66a17f1bdda29fa9e7245f36cdd3a141c46820b5c3e5e827c9d7a65598ad112fd003762db47794bf8435ed713f423ec4acd02b7ed090407f9fe52a29f3072caf19cbbfdc3cec836e74838b86710bbc1e056676c1b974e3f4d52aed8bf3f95494fd2cf1939fcb138b297d9aa4a25aa450cb59371577235aea89eca865645839eefda94f23ae1a0bdf429be14fc0abd18c3257a51f774aa92d84512a0fc1c7d9e8f7b59d990f14b55cbe68a525d131c74157d81477e4528c2c2705ad798b579ec220f445d43d7f2a1afa30685286d1fe7b2525d281c741d5dcf63ff45c8c27af106a3195a59da4c769109c26ea42ff1c16f2a5b7843abb2c57351a9ae1f0eba896ee671df11a2b08cbca76be5ea2c76910582fe8bbec207fe4b8d4fddf7b9a4549715077d95bec6239f1592bc126306f8d479ec220f44dd46b76328b3a95d5236662e29d5aeefa07be8bf79dc0c21a95d6259062e29b3d8451608ba97bec5074e51cf39c512c5f5a4bafc39e80eba9387cd177a3a24566830e71449ec2209e4dc4d47f9b85246450a39aad5830b4a756d72d07df46d1ef83c21a855623319956905a9d2d8451a487a901ee22367291d8a7540f9972dae4d1f7bd572d0091ae569e6402016256c090c824accadf35125a5c8500a8a18a34779f4b9cae74e6eb8f2d00b31f4632c4e0e7a9cbecf5334600bce97029c7ad40125d6c868aa360bb43d4f2ff0818bf85ac4b5c8eb8e73606438eadc168a3a43616783b38faf2be96c09c20f873e85d347764b243c1cf587a3ebfcfd23b84e6b81106c2a7ca170b06b64a02f38b4c62f8e2979be48c0dfbfce3f14e2d7f2cdec9ea83fb0b3d33f285f67f644468602c1f6507f90ea31b9d388280b9f7692f0ad94d2298318bb80bfb0a34c5c6769ae1d8aeb6c5ce768aea728ae73713d55719d87eb7ccddf0b547f9f4685aa7cd3a848157f0131fe2a0d772ec49d8b708fe133c77d92a6b9f3ca4e51f9099a755cbc6c5cceef137fe7e7448de5185bc12ec2952336822a69369188562547f3229a059fd9225acd29721b04ab46303782d4886045b1017230fead866a1194d1f934570e3b4c363172b6fb219a354a0dcbcabe93de19fbde68adb5d68e9da2a5b1cbe5eb6bef8fa72bc230a2f9e0b100e91aa98c9a68162d14699db18072da741cf72ee22ee177a5e48100ee4a33b5c8022e91eb2ae059d24669c57afea54c7cb95f531e8fe3018766457905f1f20a68255ce2e575d0c546d16d8ae8ddfae81723ba0fd13b9346bf44445f45ab8da2db15d1d7e9a3af43f4f588fe89a4d1d78be89fa00d46d12545f44bf5d1fd88de87e881a4d1b788e8bd749951f47445f4803e7a3fa20f207a3869f40c117d2b05e5e8ab308e8f2ce44173e3d6cc1ca5903efc6e4ca53d987a7b15e10be3e10b11fe72117e27849c0b1f131f0b1ff7064fe9a03efce710fef3087f55d2f09f14e18730198cd4c7cd99334abbf5e10f20fc4184bf2169f83d223cf6bf72f85b64f51e5673147399e768389723772aff760f55d560e67d2671877fab19bb59c0e75f47e93f6252accc837fa791657a851055811947f415cccfafa2db7d8da6d361f4975b31f56fc31cbd9d96d39d0aa19eb8500f84f2e690c137dc8a6784f7a3a9cc7d946cb67bdd5c93dd3d76d9bdf1c4566292c89b277af531e4fd267af5b730dbef5374b4a9223aef68d874cbd19f137d9d68b3910d79311b3c091bf23436d474d68e5d686d4a2b4c3bef2e2aad2d4c9bdf64e37f2eb4f1d97d551abbe7eceb0a87006bfa192a97e86ac6dea732a1d90d748473a88d1e86578fc0abefc2ab3178f528bcfa1efac863b4069f1b71c83bd7d93a30e68b7086f7bfcd71f736a3befdc23d9c0c26edde5388fa73b8f70c5c7b56e3de7ee11ece0613712f5fe75efe78ee2d48b8b7cec4bd1bb4eebd04cd2fc3bddfc0bddfc1bd57e0deab70ef349c7a0dee9d867bafabdc3b804ea777efa0700fc717b9bed524fe6314e56bdcb3ed48eedf3f10f74df8f7167c7b5be15fbe88cffdc3316622fe15e8fc2b18cfbfc6847f979af8f765ad7f67f97f11a429fcf0c2ac54ced2b078dba889d9a98349b4069f1b59a6cabfff442fd7fb7748f887d3d6e4fd63f9d05240122b22072bd6f87748f88733d744fc2bd4f957389e7f7313fe054cfcbb55e31fab80e659f0af12fe55c1bf39f0cf05ffaae19f1bfe55c3bff355fedd029ff4fe1d16fee160388e7f92897f4dd0b210fe2d867f4b34fe1d16fee14016f7cf2af6b486fe15e9fc2b1acfbfba85c2bf221b5f6293fbf775ad7f6dd0dc0eff56c03f2ffceb807f17c33f1ffceb847f3ef87789cabfbbb01cebfd3b22fcc3c151aeaf47f6af40e35f6eba89811b2066230cdc0c032f5518582012700371c29ec80358ac33b0783c03e72d120616dbf82622b981dfd41ab8039a4330f07218d80f0307606018064660e0200c8cc0c0619581dfc086436fe03161e0bd583a27ff00ee83964fc3bf2be1df67350fe031e11f0ee01379004b74fe958ce75ffd62e15f898def9292fbf780d6bfeba0f97af87700fedd00ff6e847f5f827f37c1bf9be1df4df0efcb2affeec78e4aefdf71e1df83f4d0c779006f87983b60e05d30f088e6013c2e0c3c41a37282fbf000f20d60bb9181e531036bb0517ba4b336ee62f9b91fd426f672b5067bb9394253150a22761f347d1b06dd0f831e80410f52157b88e6b113b4948d522b3b1537a71c67b0ef88131654c5cd6987f6ef0a73c6b0af89695f2bef4d8ace99334a8f097b2037f906853d06298fc39e1f500e7b42614f9148c1ed799cbe2fa738296fa25718d95311b3a716f6fcb833d7593b763b653f424f6ec8fbd9497afad1c44f8cfc71e051fa37154af4dc8794a7f0e919887b163e3d079f5e804fbf2017fb2535b05fd332f622b5b197143e55628f15f36945dca71528e259e1d3f3f4825c449bec53a6ec536eb98137e21cc07e8ff47f80377f54f8922942725f7e41bf9443fe45ee5b03dc974a8d2ff5da73c0cac40cd4fc2dd95c2cc25c6c586273976222fe3a3611ffac9e885567a846a2ffe513b14414d000b9c4de42016fc3bf77a894bd8b67ec7d4cc40fa8917d48cbd9bf30193fa22dec0c05f1b9d3c2e25e6e4113e1af15f8841c887b3980c25f145efe1f7688b1c28fca8537082fedb109292d732bc517c7c49795da4ed16f2e5b26d4ffa92ce1790159a5b3a8c1c6f58b1a086ae3e71e4b26d92c592459b2c961c9a11ccb14aab0e4921b9ff32c7971cdfcb731cdfc4d4beced0477816be6b07e8b9d6c4ab0f24c60999e5b94b05e3581f59a0696e53c143a83a6586652a9c54955960aaab1cca2464b252db7cca60ecb1cda627151109f3b2d351a58fb0d609d16b07e4f7f9824ac3f9ac37a8d891ad4b016a08646c05a08588b006b31602d01acc580b54c036bbf01acd302d69fe8cfa9c1ca3781657a4c52c2faab09acbf6961ad40a12b01cb0b581d80e503ac4ec0ea02ac6ec05a0558ab016b1560add5c03a6800eb0d01ebef38ef4c0ed63fcd61fd8d891ad4b070e6b0f402961fb0fa002b00585b012b0058db34b00e1ac07a43c07a8bde4e0d5681092cd3339912d6bb26b0ded7c2c2decc320458c3801505ac5d80b51bb0f600d65ec0ba02b0f601d6158075a506d6210358ef09581fd0879384f56f7358ef3351831ad6d5a8e11ac0ba0eb0ae07ac03807510b00e00d68d1a58870c60bd27607d44675283556802cbf400a880c528392c66d1c2ba05851e06ac5b01eb36c0ba03b0ee04acbb00eb0860dd0d584701eb6ec0fa8606d6613d2cc65fd465302b4ee19382c5eca6b0a05fd4a086f5006a7810b04e00d628609d04ac53807512b01ed6c03aac87c5c341adc4d25383556c02cbf4b0a484956902cba185f5040afd2160fd08b07e0c584f02d64f01eb6780f514603d0d58cf00d6d380f5bc06d631035859025636cb9924ac5c73580e266a50c37a0935bc0c58bf05acdf01d62b80f52a60bd0258af69601d33809525604d6579a9c12a328165fa6a4009abc004569116d6df51e83f00eb4dc0fa2760bd0d58ef00d6bb80f51e607d00581f02d60780f59106d6110358850256312b9924ac69e6b08a98a84105cb6a279b5522c99a410e6b26e558b3a8c2ea20373ee7597334b08e18c02a14b0cad8f4d4609598c0323d462b61cd3081e5d4c0b296a2d06934c55a46a5d6e954659d4135d699d46875d2726b39755867d1166b2505f1b9d33a4703ebb801ac99025639ab9824ac4a73584e266a50c39a871aea016b3e602d00ac46c06a02ac46c05aa48175dc00d64c016b36ab4a0d56b909acf289c27299c0aad1c26a41a1ad80d50658ed80b512b0bc80d5015817035627607501562760ad52c262d53864eb61b905ac5a76fe2461d599c3aa61a20635ac8da86113605d0a585b00ab17b02e03ac5ec0ea53c292356b61b905ac79ac3e35581526b02a260a6bbe09ac262dac300a8d00d620607d12b086012b0a582380b50bb0f600d65ec0da0358fb54b016e0e4af87d528c35a3849588bcd61353151831ad61750c31701eb6ac0ba06b0ae05aceb00eb5ac03aa08215d3ac85d548fc4dc615b44fd6dc75eecde4b4a9579efd3ae5f01737f96c297f73733c2e0a3fc94bbc1db1de84fc37539ef590f2ad245bc65fdc206a33f1ff81c2f6ff504b0708db25b9c14b1100003e360000504b03041400080808000d5d0e4f000000000000000000000000290000006f72672f61696f6e2f61766d2f757365726c69622f6162692f4142494465636f6465722e636c617373ad9b097c54d5bdc7ff67669219269364b210024960020249580261dfb36b62586c804ae2c22499240393199c4cd8b48a2d280ab880280828c54a000511855045acdd9ee2ab5b5b6b5fb5cf3e6bd5576bd1aad59a36fd9dbbcdb93313bc4ef948e6ce3df79cf3ff9deff99fffff9c9b78ee5f4f9d25a2a9ac82d18840b0add8ed0df88bddab3b8abb3a3d419fb7a9d8dde42d2e2bafa9f434075a3c412b3146ce15eed5ee629fdbdf56bcb06985a739642533a3d470adf1bc02a301e5cb16575d3bbfacfe7246acc60c3b7d6a617d4d43152fb031b2b4b843a86c6a2c67645b15e8f486208151e26cafdf1b9acb28a1a0b1bc7029237341e15207a590d34e164a73501239069089321c944c56fe6d20fa0ab57b3b198dac3330945918488bf475be27d41e6859e0eef030ca2c28ac0b0faf3e14f4fadb503355aeb9d0ef918b1c944343ec309acbc8de21b44f8fd5da195966251706dbe609d5b7078221696cf56004e90cd7443ca8f1cbc53528f232b2a2a82ee06f93ca6a51e6c30fae0378b9c7df166ac7e00b6a78f591171a7bd5da66cf2a0ed84ac58c665702bdabd5ebf1b5b85a029e4e973f1072b5bb577b5c1e7fa0abadddd5b42e84529fa735e40a055c418fbbc5e5f6bbdcc1a07bdd781b4d6434b0207abcf2344db2d3049aeca0e13482739aca686e1cd6f87c6af6a6631ea43a8b3cc12a9fa7c3c31925494f5506c9da3c95a3a2440b6e95dedcee695eb9a0cbe7abea58155ac77538682ef72413cd6334331e0c52214495312a5ce0591b727964452eafdfd512eecf2bf7a655afd0bc8e6b0c047c1eb75f92d9c0684e7c3ae44ed0f7a58cc61a92a2b580bba46b6a2adadd417773c81394f440e8acb8f474729746dff319151951a3d65fc82825bccae475114685f5e069e3d2e2f122f8ac576e0f3b5860e30ce8129b2c71d0281acdbde5dba28bc90b323eeff1a12d7a6e30e83d4af5ab1c5448455cc83522ad6a5fc02d878bea7867ad9577010b4d06674daddf8235198e0092102bb5421ce8957b439d8b038a381e9daa1dd44e5e3bb5d10a31a45606ba9a7cf262ad8c3328a126ef0382b09ac6181980d660952e3ecb5aac044f7372e8f21854859682dac24a0785a8cb4e9db45a5c3d3cde94f150c46b15f26436488a3af3bd7e393855078272b674d07a39f45ccfa8d868e8d082e0771c348ec6f3e637e913cbbace90a7c34a37232948759b03aba0a5480cd0b2fd5935318a6a78d4fe1e6db4d3776913ba685287632507c27c64c812460a177634e94a4d8d0d56da0a00d1a14568870033d9c8e89bd5b61a82bbe05ecd113d9a1a2bacb48351863e8408f6b0ee27188e479aadfb90df3b859e4c8df556ba5f24a24426c112a2eaa46f126134630f60538032cd548d95be2ffa180f38829d5a83fec3fd58b3f13026d717eec7d4586ba543223769bd0a56aa0d7293228266e651706b157a3235565be931ecaf2256bd60086b7fa2f195ab597a027b8016b12f5363a5954e190c039dd29e05dd9c8e37f2683d3cc5685ebc5b1cad93337cef946aa77c3a8b752517ab9b9b24f996471aec1413e53b314996b5b4043d9d78968a5d2cdffd2905b38ca63cb75c1f3a7e1677a60df7f15f7c77165661a517ec748e8fcbea56852647c874284f943186bda5a45208b009f0161e6173fb89b0523507bd2a87d9d71895187185924a7da4fd9583d6d23adec3eb8c5c15812e54e635654d910d6cf406b6e4c811a32f78f8d036e018ac1983b0d29b62a0c43075a1541a2922ec14a303905b6b6378db41b7d1ed7c0cff87035e3f6310dbd8e88f923044f03f311a2c088b8ce1923404f16906a545c7f1ff77d01d742717f7218e2db1c545b4b2d147885fbc505101a908fc1f8b01b9a4520cfd92cc7a6311991bd487ffcf1cb493eee512ffce283fb644a1858dbe942421477ca59f567d969044d5189fd6c844d1e7a0bdb40fb218eb775a756d6ccc2c09abb1b204fdb212728aa4aad6f86a11f30a1be0a087e8075c5252bfab25dcc0c692253db55696aa9f3b31fd4882aa8dcf9d2e05b10c071da147b8a281fdce9dd0c2c6064992aaad6c30a32c41922e53499a2a0dee5d60419fad589e831ea7135cd430c95aa595e58b13229fa1155b03612bd6fb044369524e0f9ae1918c86c56020d6b2b1d15a92511464c4b06f6545e29429c15b69e0e492f531ddd85e4809fc9adef10efa09fd94839a1073f6225ad85849387b285a52f44aac6c0ab6328b835e4f0bcf574a47adc1400738f8bb7c3e5720e8f2f017048242289916e7c9dcef0a48d9085dcc6054f19f74a15101cee48a80bf33e4f68796ba7d5dfc4c52816120e5d779fd9e055d1d4d9ee062b7745849af0b34bb7d4bdd412fbf570a93eb436ea44cf72ae5de5e1fe80a367baabd3e0ff61c26b210e1670825127fd537077726b2e17e8070cfc3611239a4efc928271a498c6f5b50632eee16a2dc846b6a510fa5178d39499945e69394f5386fc0e6e1335d329382cf5474ecc4b734568a922cb9190da26c22e91b3783b44a832141ee7c8dd2791e2b7a92321f2687995fcfee271babeb265bd129caab1b731c15ccac0c9f7632a7597ac962a57cc1b48bd230da2c1a4139345232ed223365e067280d833974af88c88131b9ccc45f6529223ad00b17318edbc64fd624a76ded8ed939eaad65f9a434eabb71c38ed945cb709bb01cc3cf793462fc85187711648cc17f6385f18f534ca7c0ec25125a137ffda098dea7985e229a8eb6ac2b4c885598a814ca12ad1112b907104dc0fc4ec4b84b681a4da21a9a4cf5344590ba44919a4c975101f710941662509254e6a004e22f799f14a56e2a1d16a175d3cd4edbba706942ccd2c498a5d698a5b698a5ced85d38b53e4a25104e1b2731eca846a2083e443403d33113d3310b9fb36911cda1569a4b37d03cda41a5d44d657482ca05324f6a9378904faf4406e776651277810b273343f25d2ea325e100253f4d1396a597f4d09467b172a6cd093fcccd69571fcfe08f731fd51cdc4aa6ec5e1aca8459ab86d54b61bd165e7c39acd661f616695ecec7a22eb019180d9fb53ccac5c8d015becfc6d864953b307f7c2d5c0e35a53194964b4a39470eaec1c2c14db23ca83cad8cf534ac1b5e9c9b2788be12250d58198d9072351cef1a485b2e8976c82214d18caa304059e0038ac0fa7e045e164b42822ab036d6d3dd64b57493c52c02b6e4e665958a80dba17505b4ae84d60e68f543eb2a416bbda6f572c097b56e56b496eab526aa5a17c45293a86a5da43ac5f6fe09ae45c97aa8ba1eaabe03553742d5064155a9a6ea0a2d90ddaaa89af74d5459a354f52f6a334a6e87a82d10b50da2ee80a8bb0451f33451dfd2425c3fa26caaa8c5b144d954514b155157f62f6a174aee87a83d10b50fa21e80a8fd31452d5383198e51b2a832bd28e7005555632c554e6d06af56645d7b5494953754907508254790851ec17a3c8a987b0c6bf1b820ab4c93b59cdc8aac2d8aac8a7e5835c754a5cda04785759a561ed3f112859d46c953e0f534783d83847016c1e24782b00a4d980feb4116b6551156d91faf404c65da345ea7f23a4d6b1eeb17d9f3283907642f02d92f80ec25207b455056a929c3515e51d6aba4a5b592b21eba81d5851354c97e7209f9c999b69f9ce11cde8de1442a4e5315df2829b6f4d08639b9676c5a9f63ccb9a7e916a9492e6f216c4e32c9dc4b531286f6f1ad9795ffdb0ca97c7425d2f6ea0d8ceeb7d87efd0e29e84d24d8b7680afd2fc2fadbb498de41b47c1751f24f60fe1eada60fb400dfa005731e13e4f1db11a36e55f652b76141ca09ba9a0737be488d90488f20b1388a447a4c12963af3dcbcdc0374c998bcfe82ede28d66d6ddf79640a694121532497cef0632db70d2a53e4c73f856baf471afd08accd2e54b4a94284ec5c684e8638cf11350fc14143e03c5cf41f10b50fc12147b41eb5fa0d847d80bd3065c6fc149b9544afb162cb351d2b686331dab31ddac31bd11cb6fabc4f40eba53d8f470a65d46986644302d8b629aa132bd5b629a20334d5098a681294f0a4b2480e7058083c91201f01e0ef04b4a0f93617804bd36964276964a05cc89cd5d3ad5b20c5accb2a88165d3356c30c80ca10e5c3b599e40264323335823d3a5915949dbb17de06476d2bd0a9924854cc80899cc0832a55164325532bb44320314324e99cc5209ccc71704b34706932680190930a300a600600a01a60860c602cc3880990030250033096026930fd7208e886130e91a986c0d4c4803b3827623f570307b917ae20033f06bc10c54c13c2881b1ca60ec3a30572e3400e64034987900530a30e5005301309500530d3097024c2dc0d401cc7c80590030f301e68a6f00663f7d5f02f310fd209eb594f5b56b294b05735002e3b4c964927464ae5d7401320e85cce16832cb40a60164ae0299ab41e61a90590e326e9069a146d64ad7b2366a65ed584b6d584b2b35326e8d4ca340465c4bddd81a703247b03590c9a42864d618213328824c451499412a99a3a2cb242a60326497c116e10a89cd4717f49ae3329b4c814d27d884c06635d8ac019bb560b31e6cae079b1be1351be03537c36bbe4b015cbbd826c16b066a5e93a3b159a3b1e9c026e93189cde33880c96c52153686f27bf6d7e6f76c95cd933aafb1eae0f05dcab72e0047759c9e6838db00e70ec0b90b70ee069ced80730fe0ec049c5d709cfbe1387be0387b71c4d843abd98382e30cd41c272766ca3f49a7243839eaeb13f66d05ce712370f223e0dc1005275f85f34375371771047b3ad669567df88c74963d635ba01a1d17b1577a9af2978deba167eb74501324a8837a2917d9ff1265e794afec9caa290ddfb0ab608701f511407d14508f02ea63807a1c504f50137b02f1e9245dc77ae826769a6e6367b06d780699e02c3dcc9ea563ec390df275380eff884602ed36d8780e33c9f78ec735c807e9c7d2eb21c65f572a902f517698f7a9907588878b8887efa7f43062fe0aab390af27015f2cff5909d2e15e4f3fc81d375c6365fed7bacd9e952513a5d32cb73cbc6f6d08b224bacd92943b37b69b495ce49f466520af4bf007a2f82de4b348abd4c13d82ba0f71ae8fd12f45ea766f61bc4b0df21babf4937b3b7682bfb3ded646f6bc44a30f6ffc66e9c5110e7cc97408cbbe57d0ab19db8939f327a995e5188ad52dcf29042ec97116e394164365170d304718f9e28bb694b1441b4c8ee7fe3fe6b6103f10c6d16d2c129fa4dbd9c0eba29658154f9b7bc321032da8873e41e9c1e659463c9da4b55098503c28bfd2dbed8d3fa3060b3724fcc4a13fe019fe4accbc98991bf0fd61f80f59f51fa214d677fa12af657c4c1f3b48e7d0aeffc9c36b22f680bf6b4db71ddc5fe092ffd8af6b25e3ac8fa24e693c1ee162d87ec854ffe0f4e0c66ba09076a35281cd2fcf5019c03de94e8ff1e67898b403f3d3efada61e10f3afadb74f4df89a4ffae71faef45d07f2f067d145b4c36b299ec643725d1749383aa4c291430a5d23a5306dd641a481b4d83688b299bb6e3bacb944b7b4c4368af29870e9a86c6457f0b4e6c9cfefbf4c1c5a09f111f7ded58f1671dfd7b74f4ff1249ffafc6e97f1241ff9358f44781fe68d02f04fd22d01f03fae3407f3ce89780fe64d09f0afad3407f2ae8cf02fd19a03f13f4e7c445ff3c4e839cfedf701abc08f433e3a3af1d5d3ed7d1dfa3a3ff4524fd7f18a7df1b41bf3716fd2ad0af06fdcb40bf06f46b41bf0ef4e783fe15a05f0ffa4b407f29e82f01fd06d0bf12f49781fe5571d1df4d5f49f4ff8933b74c3fa8d03f120ffd8111f45b8dd1c7f9288503cd60a4c37f40c4cf4c1afed405726d8bc67f1346b2378abf5de3cf12f5fc71aff04f12f8b780bf07fcdbc0bf1dfcbde0bf12fc7db4deb48a369882b4c914a2ada62eda81eb6ed33ab05f43fb4c6be990e97a8dffad1aff7d48e732ff0d2851f91fd1f8efa7fd8cbf9363ccca6c17837f567cfcb334fe761dffc33afe8e28fe29c6f93b23f83b63f1ff1ef86f04ff5bc0ff56f0df0cfeb783ff16f0bf13fcef06ff1de07f0ff8ef00ff5de07f2ff8df07fef7c7c5bf1b6713ce3f8da55f0cfe83e2e33f48e39fa9e37f5cc73f2b8a7fb671fe4322f80f89c5ff00f83f04fe0f83ff41f0ef06ffc3e07f04fc8f81ff71f03f01fe4f80ff09f0ef01ff93e07f0afc7f1817ff636cb0c43f87e52afcaf53f81f8e877f76047f8f31fed91affa13afe3d3afeaefec3ffd7e21f1e817f78acf0ff1cf0ff18f87f0afc3f03fe9f03fff3c0ff02f0ff02f85f06fe5781ff35e07f15f85f07fe5f01ffafa9dbf4464cfc760d7f38fc1fd6f03f482759be847f040e4817c1fdf3e373ff7c0dff281dfe7c5df6cd8b72ff02e3fcc744f01f13cbfddf06ff3f80ff3be0ff47f07f17fcdf03fff7c1ff43f0ff08fccf83ffc7e07f1efc3f03ffbf81ffa770ffbfc7e3feac901549fcc7b2711783fff0f8f80fd7f817ebf89fd3b9ffc428fe938cf39f1ac17f6a2cfe7d64c119dd663691dd6ca6e9660b559913298016ebcd49b4c19c4c9bcca9b4d5eca41db8ee3667d25e733aed3367d02173565cfc27b329d2df01cc857df95751cb505bfa6b93c83f6651084de7637e9c84df7ea5c94b3885bf5f300fa134730ee59af384df78a97fb862e2ff9781626689626688ee058d6263a6de066a0e164cb828c59c4f83cd230413433413af5ec844a26662f6054d8c8289d1305118c30463e592a1847f03504b0708d6826f4acc120000a9380000504b03041400080808000d5d0e4f000000000000000000000000250000006f72672f61696f6e2f61766d2f757365726c69622f41696f6e4275666665722e636c617373ad586b7454d515fece3c329361204320bc1260084127936090f8842492270403a289d0402bdc2437c9c064269d9900a9f555c1b76d156dabd6175a692db554e551d0a0d5be28d6d6b6da97565beba3ab5dababcbaefec1d2ef9c7be7cecd6442d3b59ab53273cf3ee7ecfded7dbeb3f7be73e2df4747005c800f05e6c7137d555a241eabd2b60f540d25f54434d255554f41c3506faf9ef0400804b66adbb5aaa816ebabbaac6babde9df2c029509059758e5c20b028b32e12db1edfa657add153fdf19e555aac27aa27cbdae2f16d43831ee409cc3bf3520fbc0279c67a81fc86ce8ee6cd6beadb2f1510ad4e623f9d16b6b76e6c96022e9fdad0ba7273ebda8ee695cd576c9693ed7222483d5d0aa4806353838077309e8ca4085dc01d8d0c445202d3cab4243d97c2645324a97545f51e5adac8ad3591582455c7a5a14d0de5eb059ca1f2f57eccc21c1f5c28f6a310d3f2e1c05c3fa6c32f9fe6fb51643c2d1070a5fa234981056dff25cacb69404b24b461c2d3a2d178b796d205ca42ade513d8599a09656b34aaf769d1fa44dfd0801e4b35efecd607a5571e84e8a5391becd606b5ee486a7859507811a69d3167d19e4a44627d8df11881b468dda97862d8834a819903da36dd106f88a4faf9944c69b1145dfc4aa86d4287bfdcb6ccb0b27cbc8d1dc3837a8ee59bdab2d9b8bc7cac8a4686b13d92d297fb710eaa7c588c2505793857a04806758c52b9aaba9074394fae183b6f1cfa053e94e342f934dbc703be98a7958e25cf7a474223571749a24ce0d46c1760ed5034ba2e1e89a5f484edc4ea7cb804c5645c9f4e8a2e50cb63917895a1e1ca588f9ee88dc677d87634f8d02877d8ae6bfb7032a50f78d0ccfba208d61d1f24d670686c105b73885aa5df2bb1ca8716b4124a4f9250f213fa80c66b11eb13f0115c433c1ed5b598ba1bbc3205ca9198165dc9a961c963ca1bfcb80ceb64d02e27d5b76bd121ca056fa3a72fbd4a7419a3c67e2da1f63432bc1cb7f7c713292568f7a3131ba5924d44c1a9a6f810afaa9a6b3236b7c5252a8e57fbb1195be45a6d54408c2d1e74531ae5e286482ad9114f2b7285569737f9a1a3d7871ef419005aa271cd00d0c28440416bcc18b6fab10d516963806e676ca80d1ec405a63016860553898bec6bf1e3d348f83008de1b11e17f94ffabf92fc7ed4650eb7b7a127a92828250799b249129207326d9861e7cd6876b24139d096d87809f5bab97ca802a90b34226d707b4547f5543a48f52bd4ff16f7a2eb9079ff3e146a56e7088fb8359acbb6cfb18d2dde4c3cd8aa6c90463eae3368b0f65a18d13b9091661d60d9954280b4de00af97107ee94c1ff3cc3da1bd5785a9ec1b406f96410a92cd43811105e6e309956166a9f88f57b70afb4fe259e19999acffd691695859a266232d0a3d677c4db4c1e4a7a3449e63e80af4afe3d68f86170ba8cd49c00aa87f18844f5285135195e99cc2b0bb54c04d4945eb9bc23de6a1057426a91447f02fb2463bfce1b409d9cf5e3499c2d4d7d93a65adc30fe4e1b14b0d8bb24348abc13413029159767586f944357a87c1393c7d37846f2fc5981c959b7c14f7336c65f1cca4df88958ce4b46fa6243037e7c57deea1b71547e3cebc70ccc94f5fc79dea7cc25af4f770ccd89449c17e7b80f2fc87b3063bc0be71b4ce8bd919d12a907d38cd4623a3949a63dab90c8d13aab4791cbda8c36c5ddcd7b454a2f0c4dc41bde8908eb515e42df1189b19dc9d33f3da4459359f52d5d4199b81d7166e0c2b173341c4ff5cbfec9dbaf2559f47b64b6eee7301537ca23b34928475115a8ce200a6e4a97ca606d505406d35d9831528d987c0c7eca8bd7d968845a5bc7abd3bf2e84c06f68bea63b6a7667b6e4db18d5645afc3d4fa2474f46127a8f7552ed292d3594f4e32dacf5e14dfc81644a7730eb8d8ae4329c2b688bc4f4b543035d7aa2435357bab08d3d5974bd9688c8b1299c4c85dddbd66883e6d8df1a8be9090540679c7dedf1a144b7de1291730166c55432c516c1686e9258404ab978653c988349f0d3a77738726032c7536ce3028e03b6f154f69cec3ad5337b4ef55d24bf03b32453393e8b12b628dcf1478e3a3972f0bb287c1825e18a839817761e44305c317210a5df51dbffc4cf199077782621cd423e374fa1d9e928c6bb6a4e29c04294a95b5e844504c0a44753675b669c7c02e6cd71edc5d46328ef9c7314e7038771d1f1637074ce79ce7b18cb0e7085137f569f629a323c05b24d5f48f365547a9632e8375461b9f22f1f35a835cdc44c33e1f00f31e9182ee93c8c15c7c323b459286d864746190d8f32e982c33fdde66c15254b686129e359cdf338df663bac5c049feb2ddbfbb84b625d5161b7fd2c4af91feca92da918d92be58d943749f93c29af70568c1cc1ea70a77c1ed922239f41e421a253982914a85278f9d948504d04d142902b5182550ccb6ac2bb1475685300830608eb3456704e9ec60c826ee34e079fd760ad097abd79fc01c6e28a1a57f123f0b8f6c1e5dc6f81f0c2710a53c40a03854fadbe92aeaeb79d7dc0b4e62655dbd141dd826bd69936aad498b3d2c67e8b52794a78952daa6e538d437683e6e6db09433ab4d88a644db12b4720ab6b550c5d32842519f4346245700e4740177de8e6b5e9219b7b79ac7da840bf2d728b4d103e7eb729600bf8b99e5ec9c86dc0274c604b4caff2c287f0c9bbb3dd1ab4b995676a14f814dd35762f55da185deeee3a82fe6f67eddf69dbefb5f647b0d5da2facfdb123483d95b5fffa9cfbd98f9afb5f278fa4b7515b583db9c21af0eeac2d498f5c5baaa7e2f4b5d78f12ba7309f34ca1712a9e339cca59bcc0c02d8cf7ad3c95db782a7710ed9db8189f274bbf802df822bdbecb764251eb84bacc132ae33d1832b9cdbedef051b4905032859eb4f918f08ee3e4eefa609697bb6f0878873352774e695e4ea927a7d49b531ac8ad2260e9a857210c78650c83df1a1dc359460c2f605900ee6344eee75d7c8039fa41c6f52126c68771051e21bf1fc5b5d8cba6f4317c138fe338be86136cda32313d69c5f47b664ccfe2fc76ec5031e57b95c99b274cde34d962ea1e27a47bc612678fc107f719f8308f690f788a48be4d3e1c201f9e66b27d0617e15934e0a00d7393857999897911e6f3e60c2bcc9fc1d526e6bde9c46ce741d0063a107ccebb260db5d2596965e44a95918fe19acecac3b8f640ced81b789f278a11c6fe3863ff22e6328a95780917e2e51c39d9c7f332f0cea5e43a666789f77adcf07fc37ba3c4bbeb4c784f12c52bc4fb53e2fd1971fc9c785f23de5f4c18efeeffb5f0dd4cf92dc72b9c56e9fb9f0adf3b24de1f09e25d969c3fb3f0bd47681fb0f07dc8c2f797710adfad630adf6dac2706e8ab3896eba716df6796bcbb6ac32587f1850c0a371cde5165ef2396b77fda6c4db56c4d65929a49cd9318ea74a9b88b49ccb0b5cc2cb279e162d3803d55ffdb5648f32c8d861eb6ddf23d76dc5a585be2b2c5361dd9e28e4c2d0c67b1c05e0b85033ee1448170519c8705c2830ae1cd510be59301275d15a58377638f096cb9e9a0275cbce710be9ce5a1986af3d063a9f4b055f88a2a63f7316d198a6a4d0ff3c3671fc14387b0375bd51c9baa7c4b553e553da6543dcecc96566560ca0f2f3c826f1cc2fe6c550bc755f52da5ea49ab79fdb599f462b6b87b72c53d30eb3332cdddd591c97bc5814096cc4d99374b96b7a5d81458e5729c8353e55254f2e016f3e0cea17809cac5b9a8154b71b9a84697380f5171beed1063966f31fae65787d8631de2c32c0f46b96ca21d592e4f585ed6cd35cbe56837e7072eba7a3a9ebaee16bb9ff3034bb2856e0a43d9c23c0a83d9420f85b3b2855e0a03d9c280dcef1d23a582b428532cb323682f96a28e11bc0401b182e206d2be112b18812b4533b6b271b84eacc43d62159e14ad7cb15f8d1f894b6d113d6145f40423ba4345f4051551f9f6710fee3579f37593372d36deb873f2269b0fae517c709f810f2a9d8b0e7a7325f9b09ee24f900f9d582636a2496cb2a16eb150b710f5b0425d63f1e000be63a23e6ab64dcde3a473b31499e9fc100eae5d6ce5f4c5564e5f7cc69c6eb0b8072ea1c32ffa3043f4a344445026b6117d14178901348a98421f36d058e89b89fe90caeb5526fa72d603599664f40fe388c9e78be9876cf8774fc40f071d39c6971f87ac04751c3cb7ccf53446eec7b4d9ae9140f071b9f205ae7cf138c717b88bdc727741782ef3f9865d6eb1eff4df67bbac2870493a0c7ccc8ac30c78541c26ad101fd3670f5e3ec53014aab034b02243ece4789861b99a61f92c975cc3b05c874a713d96881bb0547c8ee1d985b5e2266c1437630bbf7bc5add8216ec38de27615b23a3adece80c89e58becaeeb682b79bf2efa9e0c5cde02da5e425e676273bac352a8c2ece7f9f1d57f6db1bbdcbcea15fcef1f626f003eb3523f392c4cd23592f49e2a19c2f493fb476db4d07b3377f2da7e91fe5dc5c9abd797fcecd3fe67d36363798af6701e3c71085fe209993f15ffd2e210ec12d0ef3edf8884d5fc0d2f7134b5fbda9af40aa0a4a4dce342becea5e8257bc8cc9e2fb36750596ba9396baf34d759e6c35aa4f11af12d5cf6c2a3c968a57d8f0192a3ea64179afb470c51370bbf657bc08c7fd703bf757bc00876a2e472ae5c7c352a6fa4cfea707a51c94aa81b36eae1cefc51cb9656e75a5fa5453bb9cbc16efba325d7e21bc1eef294c939980574088596e1beb5f27e837e011bf61387fcbc4fc7b148937512ade22fbdf46957807e78a3fa146bc8b3af13e56890fb0417c884e3e6f167fb512c50abe010ca9444cd72cd66b78955dae401139ff73ca64f45eb398728dd9742c70d5485f5ccc0d0fa02830bfb85ffa5452bda56697e3f4bed37f2b1ef5a3c8c7c817a228f37b91f8071ce2231ede3f319bdff3c5bfacdc9bcf15c6eb298d58bf71cc67b3ed5724fd257e65eb7fe4894d530720c32e111dc56f81ecab77ca76c0d34ca55efc8e9d9da1ea3c35c3d6b4d071086fdf6f36b9cf60c4f851cf6c70fd66836bb4a29369fe3d452341d2e4f37b36de57cbdd6cb6254b1dea97870af5f9c67f00504b070818238c69450e00002a200000504b010214001400080808000d5d0e4fbc26827d44000000430000001400040000000000000000000000000000004d4554412d494e462f4d414e49464553542e4d46feca0000504b010214001400080808000d5d0e4f15b48912ab060000cf0c000022000000000000000000000000008a0000006f72672f61696f6e2f756e6974792f506f6f6c437573746f6469616e2e636c617373504b010214001400080808000d5d0e4f491bfa8128010000c10100002b00000000000000000000000000850700006f72672f61696f6e2f61766d2f757365726c69622f6162692f414249457863657074696f6e2e636c617373504b010214001400080808000d5d0e4ffbc81a0b080f00008e2500002900000000000000000000000000060900006f72672f61696f6e2f61766d2f757365726c69622f6162692f414249456e636f6465722e636c617373504b010214001400080808000d5d0e4fdb25b9c14b1100003e3600003200000000000000000000000000651800006f72672f61696f6e2f61766d2f757365726c69622f6162692f41424953747265616d696e67456e636f6465722e636c617373504b010214001400080808000d5d0e4fd6826f4acc120000a93800002900000000000000000000000000102a00006f72672f61696f6e2f61766d2f757365726c69622f6162692f4142494465636f6465722e636c617373504b010214001400080808000d5d0e4f18238c69450e00002a2000002500000000000000000000000000333d00006f72672f61696f6e2f61766d2f757365726c69622f41696f6e4275666665722e636c617373504b0506000000000700070050020000cb4b0000000000000042220000000000000000000000000000000000000000000000000000000000000000220000000000000000000000000000000000000000000000000000000000000000");
    }

    @Callable
    public static Address getStakerRegistry() {
        requireNoValue();
        return stakerRegistry;
    }

    /**
     * Registers a pool in the registry.
     *
     * @param signingAddress
     * @param commissionRate the pool commission rate
     * @return the pool coinbase address
     */
    @Callable
    public static void registerPool(Address signingAddress, int commissionRate, byte[] metaDataUrl, byte[] metaDataContentHash) {
        // sanity check
        require(commissionRate >= 0 && commissionRate <= 100);
        requireNoValue();
        // TODO: sanity checks on metaDataUrl and metaDataContentHash

        Address caller = Blockchain.getCaller();

        // make sure no one has registered as a staker using this identity
        require(isStakerRegistered(caller));

        // make sure no one has registered as a pool using this identity
        require(!pools.containsKey(caller));

        Address poolRegistry =  Blockchain.getAddress();

        // step 1: deploy a coinbase contract
        System.arraycopy(poolRegistry.toByteArray(), 0, poolCoinbaseContract, poolCoinbaseContract.length - Address.LENGTH, Address.LENGTH);
        Result result = Blockchain.create(BigInteger.ZERO, poolCoinbaseContract, Blockchain.getRemainingEnergy());
        require(result.isSuccess());
        Address coinbaseAddress = new Address(result.getReturnData());

        // step 2: deploy a custodian contract
        System.arraycopy(poolRegistry.toByteArray(), 0, poolCustodianContract, poolCustodianContract.length - Address.LENGTH * 2 - 1, Address.LENGTH);
        System.arraycopy(stakerRegistry.toByteArray(), 0, poolCustodianContract, poolCustodianContract.length - Address.LENGTH, Address.LENGTH);
        result = Blockchain.create(BigInteger.ZERO, poolCustodianContract, Blockchain.getRemainingEnergy());
        require(result.isSuccess());
        Address custodianAddress = new Address(result.getReturnData());

        // step 3: create a staker in the staker registry
        /*
        registerStaker(Address identityAddress, Address managementAddress,
                                      Address signingAddress, Address coinbaseAddress, Address selfBondAddress)
         */
        byte[] registerStakerCall = new ABIStreamingEncoder()
                .encodeOneString("registerStaker")
                .encodeOneAddress(caller)
                .encodeOneAddress(poolRegistry)
                .encodeOneAddress(signingAddress)
                .encodeOneAddress(coinbaseAddress)
                .encodeOneAddress(custodianAddress)
                .toBytes();
        secureCall(stakerRegistry, BigInteger.ZERO, registerStakerCall, Blockchain.getRemainingEnergy());

        // step 4: add the pool registry as a listener in the staker registry
        byte[] addListenerCall = new ABIStreamingEncoder()
                .encodeOneString("addListener")
                .encodeOneAddress(caller)
                .encodeOneAddress(poolRegistry)
                .toBytes();
        secureCall(stakerRegistry, BigInteger.ZERO, addListenerCall, Blockchain.getRemainingEnergy());

        // step 5: update pool state
        PoolState ps = new PoolState(caller, coinbaseAddress, custodianAddress, commissionRate, metaDataUrl, metaDataContentHash);
        pools.put(caller, ps);
    }

    /**
     * Updates the signing address of a staker. Owner only.
     *
     * @param staker the staker address
     * @param newAddress the new signing address
     */
    @Callable
    public static void setSigningAddress(Address staker, Address newAddress) {
        requireNonNull(newAddress);
        requireNoValue();
        require(Blockchain.getCaller().equals(staker));
        requirePool(staker);

        byte[] data = new ABIStreamingEncoder()
                .encodeOneString("setCoinbaseAddress")
                .encodeOneAddress(staker)
                .encodeOneAddress(newAddress)
                .toBytes();
        secureCall(stakerRegistry, BigInteger.ZERO, data, Blockchain.getRemainingEnergy());
    }

    /**
     * Delegates stake to a pool.
     *
     * @param pool the pool address
     */
    @Callable
    public static void delegate(Address pool) {
        Address caller = Blockchain.getCaller();
        BigInteger value = Blockchain.getValue();
        requirePool(pool);
        requirePositive(value);

        detectBlockRewards(pool);

        // transfers the value to the custodian contract if it's from the pool owner.
        // The reason for this is to make the stake (value) in case the pool misbehaves.
        PoolState ps = pools.get(pool);
        if (caller.equals(pool)) {
            secureCall(ps.custodianAddress, value, new byte[0], Blockchain.getRemainingEnergy());
        }

        delegate(caller, pool, Blockchain.getValue(), true);
    }

    private static void delegate(Address delegator, Address pool, BigInteger value, boolean doVote) {
        PoolState ps = pools.get(pool);

        if (doVote) {
            if (delegator.equals(pool)) {
                byte[] data = new ABIStreamingEncoder()
                        .encodeOneString("vote")
                        .encodeOneAddress(pool)
                        .encodeOneLong(value.longValue())
                        .toBytes();
                secureCall(ps.custodianAddress, BigInteger.ZERO, data, Blockchain.getRemainingEnergy());
            } else {
                byte[] data = new ABIStreamingEncoder()
                        .encodeOneString("vote")
                        .encodeOneAddress(pool)
                        .toBytes();
                secureCall(stakerRegistry, value, data, Blockchain.getRemainingEnergy());
            }
        }

        BigInteger previousStake = getOrDefault(ps.delegators, delegator, BigInteger.ZERO);
        ps.delegators.put(delegator, previousStake.add(value));

        // update rewards state machine
        ps.rewards.onVote(delegator, Blockchain.getBlockNumber(), value.longValue());

        // possible pool state change
        if (delegator.equals(ps.stakerAddress)) {
            checkPoolState(ps.stakerAddress);
        }
    }

    /**
     * Revokes stake to a pool.
     *
     * @param pool   the pool address
     * @param amount the amount of stake to undelegate
     */
    @Callable
    public static long undelegate(Address pool, long amount) {
        requirePool(pool);
        requirePositive(amount);
        requireNoValue();

        detectBlockRewards(pool);

        return undelegate(Blockchain.getCaller(), pool, amount, true);
    }

    private static long undelegate(Address delegator, Address pool, long amount, boolean doUnvote) {
        PoolState ps = pools.get(pool);

        BigInteger previousStake = getOrDefault(ps.delegators, delegator, BigInteger.ZERO);
        BigInteger amountBI = BigInteger.valueOf(amount);
        require(previousStake.compareTo(amountBI) >= 0);
        ps.delegators.put(delegator, previousStake.subtract(amountBI));

        long id = -1;
        if (doUnvote) {
            byte[] data = new ABIStreamingEncoder()
                    .encodeOneString("unvoteTo")
                    .encodeOneAddress(pool)
                    .encodeOneLong(amount)
                    .encodeOneAddress(delegator)
                    .toBytes();
            Result result = secureCall(
                    delegator.equals(pool) ? ps.custodianAddress : stakerRegistry,
                    BigInteger.ZERO, data, Blockchain.getRemainingEnergy());
            id = new ABIDecoder(result.getReturnData()).decodeOneLong();
        }

        // update rewards state machine
        ps.rewards.onUnvote(delegator, Blockchain.getBlockNumber(), amount);

        // possible pool state change
        if (delegator.equals(ps.stakerAddress)) {
            checkPoolState(ps.stakerAddress);
        }

        return id;
    }

    /**
     * Delegates block rewards to a pool
     *
     * @param pool the pool address
     */
    @Callable
    public static void redelegate(Address pool) {
        Address caller = Blockchain.getCaller();
        requirePool(pool);
        requireNoValue();

        detectBlockRewards(pool);

        PoolState ps = pools.get(pool);

        // do a withdraw
        long amount = ps.rewards.onWithdraw(caller, Blockchain.getBlockNumber());
        if (caller.equals(ps.stakerAddress)) {
            amount += ps.rewards.onWithdrawOperator();
        }

        if (amount > 0) {
            // transfer the rewards to the custodian contract
            if (caller.equals(pool)) {
                secureCall(ps.custodianAddress, BigInteger.valueOf(amount), new byte[0], Blockchain.getRemainingEnergy());
            }

            delegate(caller, pool, BigInteger.valueOf(amount), true);
        }
    }

    private static class StakeTransfer {
        Address initiator;
        Address fromPool;
        Address toPool;
        Address recipient;
        long amount;

        public StakeTransfer(Address initiator, Address fromPool, Address toPool, Address recipient, long amount) {
            this.initiator = initiator;
            this.fromPool = fromPool;
            this.toPool = toPool;
            this.recipient = recipient;
            this.amount = amount;
        }
    }

    private static Map<Long, StakeTransfer> transfers = new AionMap<>();

    /**
     * Transfers stake from one pool to another pool.
     *
     * @param fromPool the from pool address
     * @param toPool   the to pool address
     * @param amount   the amount of stake to transfer
     * @return the pending transfer id
     */
    @Callable
    public static long transferStake(Address fromPool, Address toPool, long amount) {
        Address caller = Blockchain.getCaller();
        requirePool(fromPool);
        requirePool(toPool);
        requirePositive(amount);
        requireNoValue();
        require(!fromPool.equals(toPool));

        detectBlockRewards(fromPool);
        detectBlockRewards(toPool);

        PoolState ps = pools.get(fromPool);
        BigInteger previousStake1 = getOrDefault(ps.delegators, caller, BigInteger.ZERO);

        BigInteger amountBI = BigInteger.valueOf(amount);
        require(previousStake1.compareTo(amountBI) >= 0);
        ps.delegators.put(caller, previousStake1.subtract(amountBI));

        // update rewards state machine
        ps.rewards.onUnvote(caller, Blockchain.getBlockNumber(), amount);

        // if the stake is from the pool owner, transfer stake ownership back to the
        // pool registry, otherwise keep the stake in the custodian contract.
        Address recipient = caller.equals(fromPool) ? Blockchain.getAddress() : ps.custodianAddress;
        byte[] data = new ABIStreamingEncoder()
                .encodeOneString("transferStakeTo")
                .encodeOneAddress(fromPool)
                .encodeOneAddress(toPool)
                .encodeOneLong(amount)
                .encodeOneAddress(recipient)
                .toBytes();
        Result result = secureCall(
                caller.equals(fromPool) ? ps.custodianAddress : stakerRegistry,
                BigInteger.ZERO, data, Blockchain.getRemainingEnergy());

        long id = new ABIDecoder(result.getReturnData()).decodeOneLong();
        transfers.put(id, new StakeTransfer(caller, fromPool, toPool, recipient, amount));

        // possible pool state change
        if (caller.equals(ps.stakerAddress)) {
            checkPoolState(ps.stakerAddress);
        }

        return id;
    }

    /**
     * Returns the stake of a delegator to a pool.
     *
     * @param pool      the pool address
     * @param delegator the delegator address
     * @return the amount of stake
     */
    @Callable
    public static long getStake(Address pool, Address delegator) {
        requirePool(pool);
        requireNonNull(delegator);
        requireNoValue();

        return getOrDefault(pools.get(pool).delegators, delegator, BigInteger.ZERO).longValue();
    }

    /**
     * Returns the self-bond stake to a pool.
     *
     * @param pool the pool address
     * @return the amount of stake
     */
    @Callable
    public static long getSelfStake(Address pool) {
        requirePool(pool);
        requireNoValue();

        PoolState ps = pools.get(pool);
        return getOrDefault(ps.delegators, ps.stakerAddress, BigInteger.ZERO).longValue();
    }

    /**
     * Returns the total stake of a pool.
     *
     * @param pool the pool address
     * @return the amount of stake
     */
    @Callable
    public static long getTotalStake(Address pool) {
        requirePool(pool);
        requireNoValue();

        byte[] data = new ABIStreamingEncoder()
                .encodeOneString("getTotalStake")
                .encodeOneAddress(pool)
                .toBytes();
        Result result = secureCall(stakerRegistry, BigInteger.ZERO, data, Blockchain.getRemainingEnergy());
        return new ABIDecoder(result.getReturnData()).decodeOneLong();
    }

    /**
     * Finalizes an un-vote operation.
     *
     * @param id pending unvote id
     */
    @Callable
    public static void finalizeUnvote(long id) {
        requireNoValue();

        byte[] data = new ABIStreamingEncoder()
                .encodeOneString("finalizeUnvote")
                .encodeOneLong(id)
                .toBytes();
        secureCall(stakerRegistry, BigInteger.ZERO, data, Blockchain.getRemainingEnergy());
    }

    /**
     * Finalizes a transfer operation.
     *
     * @param id pending transfer id
     */
    @Callable
    public static void finalizeTransfer(long id) {
        requireNoValue();

        require(transfers.containsKey(id));

        StakeTransfer transfer = transfers.remove(id);

        byte[] data = new ABIStreamingEncoder()
                .encodeOneString("finalizeTransfer")
                .encodeOneLong(id)
                .toBytes();
        secureCall(
                transfer.initiator.equals(transfer.fromPool) ? pools.get(transfer.fromPool).custodianAddress : stakerRegistry,
                BigInteger.ZERO, data, Blockchain.getRemainingEnergy());

        delegate(transfer.initiator, transfer.toPool, BigInteger.valueOf(transfer.amount), false);
    }

    /**
     * Returns the auto-redelegation fee set by a delegator, or -1 if not set.
     *
     * @param pool      the pool's address
     * @param delegator the delegator's address
     * @return the fee in percentage, or -1
     */
    @Callable
    public static int getAutoRewardsDelegationFee(Address pool, Address delegator) {
        requirePool(pool);
        requireNoValue();

        return getOrDefault(pools.get(pool).autoRewardsDelegationDelegators, delegator, -1);
    }

    /**
     * Enables auto-redelegation on a pool.
     *
     * @param pool the pool address
     * @param feePercentage the auto-redelegation fee
     */
    @Callable
    public static void enableAutoRewardsDelegation(Address pool, int feePercentage) {
        requirePool(pool);
        require(feePercentage >= 0 && feePercentage <= 100);
        requireNoValue();

        pools.get(pool).autoRewardsDelegationDelegators.put(Blockchain.getCaller(), feePercentage);
    }

    /**
     * Disables auto-redelegation on a pool.
     *
     * @param pool the pool address
     */
    @Callable
    public static void disableAutoRewardsDedelegation(Address pool) {
        requirePool(pool);
        requireNoValue();

        pools.get(pool).autoRewardsDelegationDelegators.remove(Blockchain.getCaller());
    }

    /**
     * Delegates one delegator's block rewards to the pool. The caller
     * gets the auto-redelegation fee.
     *
     * @param pool the pool address
     * @param delegator the delegator address
     */
    @Callable
    public static void autoDelegateRewards(Address pool, Address delegator) {
        requirePool(pool);
        requireNonNull(delegator);
        requireNoValue();

        detectBlockRewards(pool);

        // check auto-redelegation authorization
        PoolState ps = pools.get(pool);
        require(ps.autoRewardsDelegationDelegators.containsKey(delegator));

        // do a withdraw
        long amount = ps.rewards.onWithdraw(delegator, Blockchain.getBlockNumber());
        if (delegator.equals(ps.stakerAddress)) {
            amount += ps.rewards.onWithdrawOperator();
        }

        Blockchain.println("Auto delegation: rewards = " + amount);

        if (amount > 0) {
            long fee = amount * ps.autoRewardsDelegationDelegators.get(delegator) / 100;
            long remaining = amount - fee;

            Blockchain.println("Auto delegation: fee = " + fee + ", remaining = " + remaining);

            // transfer fee to the caller
            secureCall(Blockchain.getCaller(), BigInteger.valueOf(fee), new byte[0], Blockchain.getRemainingEnergy());

            // use the remaining rewards to delegate
            if (delegator.equals(pool)) {
                secureCall(ps.custodianAddress, BigInteger.valueOf(remaining), new byte[0], Blockchain.getRemainingEnergy());
            }
            delegate(delegator, pool, BigInteger.valueOf(remaining), true);
        }
    }

    /**
     * Delegates to a pool and enables auto-redelegation.
     *
     * @param pool the pool address
     * @param fee the auto-redelegation fee
     */
    @Callable
    public static void delegateAndEnableAutoRedelegation(Address pool, int fee) {
        requirePool(pool);
        require(fee >= 0 && fee <= 100);
        requirePositive(Blockchain.getValue());

        delegate(Blockchain.getCaller(), pool, Blockchain.getValue(), true);
        enableAutoRewardsDelegation(pool, fee);
    }

    /**
     * Returns the outstanding rewards of a delegator.
     *
     * @param pool      the pool address
     * @param delegator the delegator address
     * @return the amount of outstanding rewards
     */
    public static long getRewards(Address pool, Address delegator) {
        requirePool(pool);
        requireNonNull(delegator);
        requireNoValue();

        return pools.get(pool).rewards.getRewards(delegator, Blockchain.getBlockNumber());
    }

    /**
     * Withdraws block rewards from one pool.
     *
     * @param pool the pool address
     */
    @Callable
    public static long withdraw(Address pool) {
        Address caller = Blockchain.getCaller();
        requirePool(pool);
        requireNoValue();

        detectBlockRewards(pool);

        // query withdraw amount from rewards state machine
        PoolState ps = pools.get(pool);
        long amount = ps.rewards.onWithdraw(caller, Blockchain.getBlockNumber());
        if (caller.equals(ps.stakerAddress)) {
            amount += ps.rewards.onWithdrawOperator();
        }

        // do a transfer
        if (amount > 0) {
            secureCall(caller, BigInteger.valueOf(amount), new byte[0], Blockchain.getRemainingEnergy());
        }
        return amount;
    }

    /**
     * Returns the status of a pool.
     *
     * @param pool the pool address.
     * @return
     */
    @Callable
    public static String getPoolStatus(Address pool) {
        requirePool(pool);
        requireNoValue();
        return pools.get(pool).isActive ? "ACTIVE" : "BROKEN";
    }

    @Callable
    public static void onSigningAddressChange(Address staker, Address newSigningAddress) {

        // do nothing
    }

    @Callable
    public static void onCoinbaseAddressChange(Address staker, Address newCoinbaseAddress) {
        onlyStakerRegistry();
        requireNonNull(newCoinbaseAddress);
        requireNoValue();

        checkPoolState(staker);
    }

    @Callable
    public static void onListenerAdded(Address staker) {
        onlyStakerRegistry();
        requireNoValue();

        checkPoolState(staker);
    }

    @Callable
    public static void onListenerRemoved(Address staker) {
        onlyStakerRegistry();
        requireNoValue();

        checkPoolState(staker);
    }

    @Callable
    public static void onSlashing(Address staker, long amount) {
        PoolState ps = pools.get(staker);
        if (ps != null) {
            // the slashing amount should be greater than the stake
            require(getStake(staker, staker) >= amount);

            // do a un-delegate
            undelegate(staker, staker, amount, false);

            // check pool state
            checkPoolState(staker);
        }
    }

    private static void checkPoolState(Address staker) {
        PoolState ps = pools.get(staker);
        if (ps != null) {
            boolean active = isActive(staker);
            if (ps.isActive && !active) {
                switchToBroken(ps);
            }
            if (!ps.isActive && active) {
                switchToActive(ps);
            }
        }
    }

    private static boolean isActive(Address pool) {
        // TODO: optimize - checking all three condition each time costs too much energy
        return isCoinbaseSetup(pool) && isListenerSetup(pool) && isSelfStakeSatisfied(pool) && isStakerActive(pool);
    }

    private static boolean isStakerRegistered(Address staker) {
        byte[] txData = new ABIStreamingEncoder()
                .encodeOneString("isStaker")
                .encodeOneAddress(staker)
                .toBytes();
        Result result = secureCall(stakerRegistry, BigInteger.ZERO, txData, Blockchain.getRemainingEnergy());
        boolean isStaker = new ABIDecoder(result.getReturnData()).decodeOneBoolean();

        return isStaker;
    }

    private static boolean isStakerActive(Address pool) {
        requirePool(pool);

        byte[] txData = new ABIStreamingEncoder()
                .encodeOneString("isActive")
                .encodeOneAddress(pool)
                .toBytes();
        Result result = secureCall(stakerRegistry, BigInteger.ZERO, txData, Blockchain.getRemainingEnergy());
        return new ABIDecoder(result.getReturnData()).decodeOneBoolean();
    }

    private static boolean isCoinbaseSetup(Address pool) {
        requirePool(pool);

        byte[] txData = new ABIStreamingEncoder()
                .encodeOneString("getCoinbaseAddress")
                .encodeOneAddress(pool)
                .toBytes();
        Result result = secureCall(stakerRegistry, BigInteger.ZERO, txData, Blockchain.getRemainingEnergy());
        Address coinbaseAddress = new ABIDecoder(result.getReturnData()).decodeOneAddress();

        PoolState ps = pools.get(pool);
        return ps.coinbaseAddress.equals(coinbaseAddress);
    }

    private static boolean isListenerSetup(Address pool) {
        requirePool(pool);

        byte[] txData = new ABIStreamingEncoder()
                .encodeOneString("isListener")
                .encodeOneAddress(pool)
                .encodeOneAddress(Blockchain.getAddress())
                .toBytes();
        Result result = secureCall(stakerRegistry, BigInteger.ZERO, txData, Blockchain.getRemainingEnergy());
        return new ABIDecoder(result.getReturnData()).decodeOneBoolean();
    }

    private static boolean isSelfStakeSatisfied(Address pool) {
        requirePool(pool);

        PoolState ps = pools.get(pool);
        BigInteger stake = getOrDefault(ps.delegators, ps.stakerAddress, BigInteger.ZERO);

        // can implement a self-bond percentage very easily here
        return stake.compareTo(MIN_SELF_STAKE) >= 0;
    }


    private static void switchToActive(PoolState ps) {
        ps.isActive = true;
        ps.rewards.setCommissionRate(ps.commissionRate);
    }

    private static void switchToBroken(PoolState ps) {
        ps.isActive = false;
        ps.rewards.setCommissionRate(0);

        // alternatively, punishment could be making the staker inactive
    }

    private static void require(boolean condition) {
        Blockchain.require(condition);
    }

    private static void requireNonNull(Object obj) {
        require(obj != null);
    }

    private static void requireNoValue() {
        require(Blockchain.getValue().equals(BigInteger.ZERO));
    }

    private static void requirePool(Address pool) {
        require(pool != null && pools.containsKey(pool));
    }

    private static void requirePositive(BigInteger num) {
        require(num != null && num.compareTo(BigInteger.ZERO) > 0);
    }

    private static void requirePositive(long num) {
        require(num > 0);
    }

    private static void onlyStakerRegistry() {
        Address caller = Blockchain.getCaller();
        require(caller.equals(stakerRegistry));
    }

    private static byte[] hexStringToByteArray(String s) {
        // TODO: use static variable
        int[] map = new int[256];
        int value = 0;
        for (char c : "0123456789abcdef".toCharArray()) {
            map[c] = value++;
        }

        char[] chars = s.toCharArray();
        int length = chars.length;
        byte[] result = new byte[length / 2];
        for (int i = 0; i < length; i += 2) {
            result[i / 2] = (byte) ((map[chars[i]] << 4) + map[chars[i + 1]]);
        }
        return result;
    }

    private static Result secureCall(Address targetAddress, BigInteger value, byte[] data, long energyLimit) {
        Result result = Blockchain.call(targetAddress, value, data, energyLimit);
        require(result.isSuccess());
        return result;
    }


    private static <K, V> V getOrDefault(Map<K, V> map, K key, V defaultValue) {
        if (map.containsKey(key)) {
            return map.get(key);
        } else {
            return defaultValue;
        }
    }

    private static void detectBlockRewards(Address pool) {
        PoolState ps = pools.get(pool);

        BigInteger balance = Blockchain.getBalance(ps.coinbaseAddress);
        if (balance.compareTo(BigInteger.ZERO) > 0) {
            byte[] data = new ABIStreamingEncoder()
                    .encodeOneString("transfer")
                    .encodeOneAddress(Blockchain.getAddress())
                    .encodeOneLong(balance.longValue())
                    .toBytes();
            secureCall(ps.coinbaseAddress, BigInteger.ZERO, data, Blockchain.getRemainingEnergy());

            ps.rewards.onBlock(Blockchain.getBlockNumber(), balance.longValue());

            Blockchain.println("New block rewards: " + balance);
        }
    }
}
